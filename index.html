<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>iTalki Tutor - Gerenciamento de Alunos e Finanças</title>
    <meta name="description" content="Dashboard de gerenciamento e controle financeiro para iTalki Tutors.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (compat para manter similar ao que você usa) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .font-sans { font-family: 'Inter', sans-serif; }
        .italki-red { color: #ff545a; }
        .italki-red-bg { background-color: #ff545a; }
        .italki-red-hover:hover { background-color: #d13d42; }
        .primary-color { color: #818CF8; }
        .primary-bg { background-color: #4F46E5; }
        .primary-hover-bg:hover { background-color: #4338CA; }
        .panel-bg { background-color: #1F2937; }
        body { background-color: #0F172A; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0F172A; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #4B5563; }
        html, body { height:100%; margin:0; padding:0; }
        body { display:flex; flex-direction:column; }
        main { flex-grow:1; }
        .form-input-style { width:100%; margin-top:5px; padding:10px; border-radius:0.5rem; background-color:#374151; border:1px solid #4B5563; color:#E5E7EB; resize:vertical; transition:border-color .2s, box-shadow .2s; }
        .form-input-style:focus { outline:none; border-color:#4F46E5; box-shadow:0 0 0 1px #4F46E5; }
        .student-item.selected { border-color:#4F46E5 !important; background-color:#1F2937 !important; }
        .login-container { background-color:#0F172A; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
        .login-card { background-color:#1F2937; border-radius:12px; padding:40px; width:100%; max-width:400px; box-shadow:0 10px 25px rgba(0,0,0,.5); border:1px solid #374151; }
        .google-login-btn { background-color:#ffffff; color:#333333; border:1px solid #dadce0; border-radius:4px; padding:10px 16px; font-size:14px; font-weight:500; display:flex; align-items:center; justify-content:center; width:100%; cursor:pointer; transition:background-color .2s; }
        .google-login-btn:hover { background-color:#f8f9fa; }
        .google-logo { width:18px; height:18px; margin-right:10px; }
        .dynamic-field { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .number-input-container { display: flex; align-items: center; }
        .number-input-btn { background-color: #4B5563; border: none; color: white; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .number-input-btn:hover { background-color: #6B7280; }
        .number-input { width: 50px; text-align: center; margin: 0 5px; }
    </style>
</head>
<body class="font-sans text-gray-100 h-screen overflow-hidden flex flex-col">

    <!-- Tela de Login -->
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-extrabold italki-red tracking-tight mb-2" style="font-family: 'Arial Black', Gadget, sans-serif;">iTalki Tutor Dashboard</h1>
                <p class="text-gray-400">Faça login para acessar sua conta</p>
            </div>

            <div class="relative flex items-center py-4">
                <div class="flex-grow border-t border-gray-700"></div>
                <span class="flex-shrink mx-4 text-gray-500 text-sm">Entre com</span>
                <div class="flex-grow border-t border-gray-700"></div>
            </div>

            <button type="button" id="google-login-btn" class="google-login-btn">
                <svg class="google-logo" viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Conteúdo Principal (inicialmente oculto) -->
    <div id="main-content" class="hidden flex flex-col h-full">

    <header class="bg-gray-800 shadow-lg border-b border-gray-700 py-3 px-6 flex flex-col xl:flex-row justify-between items-center z-10 space-y-3 xl:space-y-0">
        <div class="flex items-center space-x-6 flex-shrink-0">
             <h1 class="text-3xl md:text-5xl font-extrabold italki-red tracking-tight" style="font-family: 'Arial Black', Gadget, sans-serif;">iTalki Tutor Dashboard</h1>
        </div>

        <div class="flex items-center space-x-4">
            <div id="user-info" class="flex items-center space-x-3 bg-gray-700/50 p-2 rounded-lg border border-gray-600">
                <div class="text-gray-300 text-sm flex items-center space-x-2">
                    <i data-lucide="user" class="w-4 h-4 text-indigo-400"></i>
                    <span id="logged-user-email">usuario.logado@exemplo.com</span>
                </div>
                <button id="logout-btn" class="text-gray-400 hover:text-white transition duration-200 p-1 rounded-full bg-gray-700/50">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>

            <div id="header-financials" class="flex items-center space-x-4 bg-gray-700/50 p-2 rounded-lg border border-gray-600 text-xs md:text-sm flex-wrap justify-center xl:justify-end">
                <button id="toggle-metrics-btn" title="Ocultar/Mostrar Valores" class="text-gray-400 hover:text-white transition duration-200 p-1 rounded-full bg-gray-700/50 self-end">
                    <i id="toggle-metrics-icon" data-lucide="eye" class="w-4 h-4"></i>
                </button>

                <div class="text-right flex items-center space-x-1">
                    <div class="text-center">
                        <label for="exchange-rate-input" class="text-xs text-gray-400 block font-medium">Câmbio USD/BRL</label>
                        <input type="number" step="0.01" id="exchange-rate-input" value="5.38" class="bg-gray-800 text-gray-100 text-sm font-semibold rounded px-2 py-0.5 w-16 text-center border border-gray-600">
                    </div>
                    <button id="update-rate-btn" title="Atualizar Câmbio" class="text-gray-400 hover:text-white transition duration-200 p-1 rounded-full bg-gray-700/50 self-end">
                        <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="text-center border-l border-gray-600 pl-3">
                    <span class="text-xs text-gray-400 block font-medium">Bruto Total (USD)</span>
                    <span id="metric-total-usd" class="monetary-value text-md font-bold text-green-400">0,00</span>
                </div>

                <div class="text-center border-l border-gray-600 pl-3">
                    <span class="text-xs text-gray-400 block font-medium">Comissão (1.5% USD)</span>
                    <span id="metric-fee-usd" class="monetary-value text-md font-bold text-red-400">0,00</span>
                </div>

                <div class="text-center border-l border-gray-600 pl-3">
                    <span class="text-xs text-gray-400 block font-medium">Líquido Total (BRL)</span>
                    <span id="metric-net-brl" class="monetary-value text-lg font-extrabold text-teal-400">R$ 0,00</span>
                </div>
            </div>
        </div>
    </header>

    <main class="grid grid-cols-12 flex-grow overflow-hidden">

        <div id="col-list" class="col-span-2 flex flex-col panel-bg border-r border-gray-700 overflow-y-auto custom-scroll p-4">

            <div class="bg-gray-700 p-3 rounded-lg mb-3 shadow-inner grid grid-cols-2 gap-2 text-center">
                 <div class="p-2 border border-gray-600 rounded-lg">
                    <p class="text-xs text-gray-400 font-medium block">Total de Alunos</p>
                    <span id="total-students-count" class="text-2xl font-bold text-indigo-400">0</span>
                </div>
                <div class="p-2 border border-gray-600 rounded-lg">
                    <p class="text-xs text-gray-400 font-medium block">Total de Aulas</p>
                    <span id="total-classes-count" class="text-2xl font-bold text-green-400">0</span>
                </div>
            </div>

            <button id="new-student-btn" class="w-full primary-bg primary-hover-bg text-white py-2.5 px-2 rounded-lg font-semibold transition duration-200 shadow-lg flex items-center justify-center mb-4 text-xs md:text-sm">
                <i data-lucide="user-plus" class="w-4 h-4 md:w-5 md:h-5 mr-1 md:mr-2"></i> Adicionar Novo Aluno
            </button>

            <div class="relative mb-4">
                <i data-lucide="search" class="w-4 h-4 absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="student-search-input" placeholder="Buscar..." class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-lg py-2 pl-8 pr-2 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-xs">
            </div>

            <h2 class="text-sm md:text-lg font-bold mb-3 text-gray-300 border-b border-gray-700 pb-1">Lista de Alunos</h2>
            <div id="students-list-container" class="flex-grow space-y-2"></div>
        </div>

        <div id="col-main" class="col-span-8 flex flex-col bg-gray-900 overflow-y-auto custom-scroll p-6">
            <div id="main-panel" class="flex-grow">
                <div class="flex flex-col items-center justify-center h-full text-gray-500">
                    <i data-lucide="layout-dashboard" class="w-16 h-16 mb-4 text-gray-600"></i>
                    <p class="text-lg font-medium">Carregando Dashboard...</p>
                </div>
            </div>
        </div>

        <div id="col-metrics" class="col-span-2 flex flex-col panel-bg border-l border-gray-700 overflow-y-auto custom-scroll p-4 space-y-6">

            <div>
                <h3 class="text-sm md:text-lg font-bold border-b border-gray-700 pb-2 mb-3 flex items-center text-yellow-400">
                    <i data-lucide="award" class="w-4 h-4 md:w-5 md:h-5 mr-2 text-yellow-400"></i> Top Alunos
                </h3>
                <div id="top-10-list" class="space-y-2 text-xs"></div>
            </div>

            <div>
                <h3 class="text-sm md:text-lg font-bold border-b border-gray-700 pb-2 mb-3 flex items-center text-orange-400">
                    <i data-lucide="bell-ring" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i> Alunos em Risco
                </h3>
                <div id="inactivity-risk-list" class="space-y-2 text-xs"></div>
            </div>

            <div>
                <h3 class="text-sm md:text-lg font-bold border-b border-gray-700 pb-2 mb-3 flex items-center text-red-500">
                    <i data-lucide="user-x" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i> Alunos Abandonados
                </h3>
                <div id="inactive-students-list" class="space-y-2 text-xs"></div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <h3 class="text-sm font-bold mb-3 text-gray-400">Backup de Dados</h3>
                <div class="flex space-x-2">
                    <button id="import-btn" class="flex-1 flex items-center justify-center bg-blue-600 hover:bg-blue-500 text-white py-2 px-3 rounded-lg font-semibold transition duration-200 text-xs">
                        <i data-lucide="upload-cloud" class="w-4 h-4 mr-1"></i> Importar
                    </button>
                    <button id="export-btn" class="flex-1 flex items-center justify-center bg-green-600 hover:bg-green-500 text-white py-2 px-3 rounded-lg font-semibold transition duration-200 text-xs">
                        <i data-lucide="download-cloud" class="w-4 h-4 mr-1"></i> Exportar
                    </button>
                </div>
                <input type="file" id="import-file-input" accept="application/json" class="hidden">
            </div>

        </div>

    </main>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="panel-bg p-6 rounded-lg shadow-2xl max-w-sm w-full border border-gray-700">
            <h4 id="message-title" class="text-lg font-bold mb-3"></h4>
            <p id="message-content" class="text-gray-300 mb-4 text-sm"></p>
            <div class="flex justify-end">
                <button onclick="closeMessageBox()" class="primary-bg primary-hover-bg text-white py-2 px-4 rounded-md font-semibold text-sm">Ok</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="panel-bg p-6 rounded-lg shadow-2xl max-w-sm w-full border border-gray-700">
            <h4 class="text-lg font-bold mb-3 text-red-400">Confirmar Exclusão</h4>
            <p id="delete-message" class="text-gray-300 mb-4 text-sm"></p>
            <div class="flex justify-end space-x-3">
                 <button onclick="cancelDelete()" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md font-semibold text-sm">Cancelar</button>
                 <button id="confirm-delete-button" onclick="confirmDelete()" class="italki-red-bg italki-red-hover text-white py-2 px-4 rounded-md font-semibold text-sm">Excluir</button>
            </div>
        </div>
    </div>

    <div id="log-class-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="panel-bg p-6 rounded-lg shadow-2xl max-w-lg w-full border border-gray-700">
            <h4 class="text-xl font-bold mb-4 text-indigo-400 border-b border-gray-700 pb-2">Registrar Aula</h4>
            <p class="text-gray-300 mb-4 text-sm">Você está registrando uma aula para <span id="log-student-name" class="font-bold text-white"></span>. O valor da aula é <span id="log-lesson-price" class="font-bold text-green-400"></span>.</p>
            <form id="log-class-form">
                <div class="mb-4">
                    <label for="log-date" class="block text-sm text-gray-400 font-medium mb-1">Data da Aula (Padrão: Hoje)</label>
                    <input type="date" id="log-date" name="log-date" class="form-input-style" required>
                </div>
                <div class="mb-6">
                    <label for="log-notes" class="block text-sm text-gray-400 font-medium mb-1">Anotações da Aula (Caderno Digital)</label>
                    <textarea id="log-notes" name="log-notes" rows="4" placeholder="Ex: Foco no Pretérito Imperfeito. Tópico de conversação: Viagens. Próxima aula: Revisão." class="form-input-style"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeLogClassModal()" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md font-semibold text-sm">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded-md font-semibold text-sm">Confirmar Registro</button>
                </div>
            </form>
        </div>
    </div>

    </div> <!-- Fim main-content -->

    <script>
        // === FIREBASE CONFIG using your keys ===
        const firebaseConfig = {
            apiKey: "AIzaSyC3n2hMTwJaq5NXoeiNJynWpkRHIRfkdQw",
            authDomain: "italki-tutor-dashboard.firebaseapp.com",
            projectId: "italki-tutor-dashboard",
            storageBucket: "italki-tutor-dashboard.firebasestorage.app",
            messagingSenderId: "106549970567",
            appId: "1:106549970567:web:4742bad1f64224b5fc9a22"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Variáveis ---
        let STUDENTS = [];
        let SELECTED_STUDENT_ID = null;
        let nextStudentId = 1;
        let EXCHANGE_RATE = 5.38;
        const PLATFORM_FEE = 0.015;
        const TODAY = new Date();
        let metricsVisible = true;
        let currentUser = null;

        const MOCK_COUNTRIES = ["Brasil","Estados Unidos","Portugal","Japão","Jamaica","Espanha","Alemanha","França","Canadá","Itália","Argentina","China","Reino Unido","Austrália","Suíça"];
        const MOCK_LANGUAGES = ["Inglês","Espanhol","Francês","Alemão","Japonês","Mandarim","Italiano","Russo","Coreano","Português","Holandês","Húngaro","Polonês","Sueco"];
        const MOCK_CITIES = ["Rio de Janeiro, Brasil","São Paulo, Brasil","Nova York, EUA","Los Angeles, EUA","Tóquio, Japão","Lisboa, Portugal","Porto, Portugal","Buenos Aires, Argentina","Madri, Espanha","Londres, Reino Unido","Paris, França","Berlim, Alemanha","Toronto, Canadá","Roma, Itália","Pequim, China"];

        const LEVEL_DESCRIPTIONS = { 'A1':'Iniciante absoluto','A2':'Iniciante com base','B1':'Intermediário','B2':'Intermediário avançado','C1':'Avançado','C2':'Fluente' };

        const FIELD_MAP = {
            fullName: { label: 'Nome completo' }, preferredName: { label: 'Como prefere ser chamado(a)' }, countryOfOrigin: { label: 'País de origem' },
            birthCity: { label: 'Cidade natal' }, currentCity: { label: 'Onde mora atualmente' }, nativeLanguage: { label: 'Idioma nativo' },
            otherLanguages: { label: 'Outros idiomas que fala' }, whatsappNumber: { label: 'WhatsApp' }, phoneNumber: { label: 'Telefone (Alternativo)' },
            level: { label: 'Nível atual de português' }, studiedBefore: { label: 'Como começou ou onde começou a estudar português?' },
            motivation: { label: 'Por que quer aprender português?' }, mainGoal: { label: 'Objetivo principal com as aulas' },
            portugueseUse: { label: 'Usa o português para trabalho, estudos ou lazer?' }, occupation: { label: 'Profissão / área de atuação' },
            workplace: { label: 'Local de trabalho atual' }, previousJobs: { label: 'Já trabalhou em outras áreas ou países? Quais?' }
        };

        const defaultStudentData = {
            id: null, lessonPriceUSD: 6.00, totalClasses: 0,
            lastClassDate: TODAY.toISOString().split('T')[0],
            registrationDate: TODAY.toISOString().split('T')[0],
            lessonHistory: [], hasPartner: 'Não', partnerName: '',
            hasChildren: 'Não', numChildren: 0, childrenNames: [], 
            hasPets: 'Não', numPets: 0, petsNames: [],
            hasHobby: 'Não', whatsappNumber: '', phoneNumber: '',
            currentStateCity: '', currentCountry: '', currentLanguage: '',
            whyStudyingPortuguese: '', whereStartedLearning: '', whyChoseTutor: ''
        };

        // --- Helpers ---
        function formatDate(dateString) {
            if(!dateString) return 'N/A';
            const [y,m,d] = dateString.split('-');
            if(!y||!m||!d) return dateString;
            const date = new Date(y, m-1, d);
            if (isNaN(date)) return dateString;
            return date.toLocaleDateString('pt-BR');
        }

        function dateDiffInDays(date1Str, date2Str) {
            if(!date1Str || !date2Str) return 9999;
            const d1 = new Date(date1Str), d2 = new Date(date2Str);
            d1.setUTCHours(0,0,0,0); d2.setUTCHours(0,0,0,0);
            if(isNaN(d1)||isNaN(d2)) return 9999;
            const diff = d2.getTime() - d1.getTime();
            return Math.floor(diff / (1000*60*60*24));
        }

        function getInactivityStatus(lastClassDate) {
            const todayStr = TODAY.toISOString().split('T')[0];
            const diffDays = dateDiffInDays(lastClassDate, todayStr);
            if (diffDays < 30) return 'Active';
            if (diffDays < 60) return 'Yellow';
            if (diffDays < 90) return 'Red';
            return 'Abandoned';
        }

        function formatCurrency(amount, currency) {
            const locale = currency === 'BRL' ? 'pt-BR' : 'en-US';
            return new Intl.NumberFormat(locale, { style:'currency', currency: currency, minimumFractionDigits:2 }).format(amount);
        }

        function calculateFinancials() {
            const totalEarnedUSD = STUDENTS.reduce((s, st) => s + ((st.totalClasses||0) * (st.lessonPriceUSD||0)), 0);
            const platformFeeUSD = totalEarnedUSD * PLATFORM_FEE;
            const netUSD = totalEarnedUSD - platformFeeUSD;
            const netBRL = netUSD * EXCHANGE_RATE;
            const totalClasses = STUDENTS.reduce((s, st) => s + (st.totalClasses||0), 0);
            return { totalEarnedUSD, platformFeeUSD, netUSD, netBRL, totalClasses };
        }

        // === AUTENTICAÇÃO E INICIALIZAÇÃO ===
        async function handleGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                await initUserDashboard();
            } catch (err) {
                console.error("Erro Google:", err);
                showMessageBox("Erro de Login", "Não foi possível entrar com Google.", true);
            }
        }

        function handleLogout() {
            auth.signOut().catch(()=>{}); // não bloqueia se der erro
            currentUser = null;
            STUDENTS = [];
            SELECTED_STUDENT_ID = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
            showMessageBox("Desconectado", "Você saiu da sua conta.", false);
        }

        async function initUserDashboard() {
            // mostra e-mail
            document.getElementById('logged-user-email').textContent = (currentUser && currentUser.email) ? currentUser.email : 'Usuário';
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            // cria datalists e liga botões
            createDatalist('country-list', MOCK_COUNTRIES);
            createDatalist('language-list', MOCK_LANGUAGES);
            createDatalist('city-list', MOCK_CITIES);

            document.getElementById('student-search-input').onkeyup = renderStudentsList;
            document.getElementById('new-student-btn').onclick = handleNewStudent;
            document.getElementById('export-btn').onclick = exportData;
            document.getElementById('import-btn').onclick = importData;
            document.getElementById('import-file-input').onchange = handleFileImport;
            document.getElementById('update-rate-btn').onclick = updateExchangeRateFromInput;
            document.getElementById('exchange-rate-input').onchange = updateExchangeRateFromInput;
            document.getElementById('toggle-metrics-btn').onclick = () => toggleMetricsVisibility();

            // tenta carregar do Firestore (se existir)
            try {
                if (currentUser && currentUser.uid) {
                    const docRef = db.collection('tutorDashboards').doc(currentUser.uid);
                    const doc = await docRef.get();
                    if (doc.exists) {
                        const data = doc.data();
                        STUDENTS = Array.isArray(data.students) ? data.students : [];
                        nextStudentId = data.nextStudentId || nextStudentId;
                        EXCHANGE_RATE = data.exchangeRate || EXCHANGE_RATE;
                        document.getElementById('exchange-rate-input').value = parseFloat(EXCHANGE_RATE).toFixed(2);
                        await saveStudents(); // também salva no localStorage para funcionar offline
                    } else {
                        // cria documento vazio
                        await docRef.set({ students: STUDENTS, nextStudentId, exchangeRate: EXCHANGE_RATE, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                }
            } catch (err) {
                console.warn("Erro ao acessar Firestore, vou continuar com localStorage.", err);
                // continua usando localStorage
            }

            await loadStudents();
            SELECTED_STUDENT_ID = null;
            renderAll();
            renderMainPanel();
        }

        // === PERSISTÊNCIA (localStorage e fallback) ===
        async function loadStudents() {
            const stored = localStorage.getItem('italkiDashboardData');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    STUDENTS = Array.isArray(data.students) ? data.students : [];
                    nextStudentId = data.nextStudentId || nextStudentId;
                    EXCHANGE_RATE = data.exchangeRate || EXCHANGE_RATE;
                    document.getElementById('exchange-rate-input').value = parseFloat(EXCHANGE_RATE).toFixed(2);
                    return STUDENTS;
                } catch (err) {
                    console.error("Erro ao ler localStorage:", err);
                }
            }
            // se não há dados locais, criar demonstração
            return seedStudents();
        }

        async function saveStudents() {
            const dataToSave = { students: STUDENTS, nextStudentId, exchangeRate: EXCHANGE_RATE, updatedAt: new Date().toISOString() };
            try {
                localStorage.setItem('italkiDashboardData', JSON.stringify(dataToSave));
            } catch (err) {
                console.error("Erro ao salvar localStorage:", err);
                showMessageBox("Erro", "Não foi possível salvar os dados no navegador.", true);
            }
            // tenta também salvar no Firestore (se usuário logado)
            try {
                if (currentUser && currentUser.uid) {
                    await db.collection('tutorDashboards').doc(currentUser.uid).set({
                        students: STUDENTS,
                        nextStudentId,
                        exchangeRate: EXCHANGE_RATE,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
            } catch (err) {
                // não atrapalha a experiência, só log
                console.warn("Não consegui salvar no Firestore:", err);
            }
        }

        function seedStudents() {
            // cria exemplos mínimos se não houver dados
            nextStudentId = 1;
            const dateMinusDays = d => {
                const dt = new Date(TODAY);
                dt.setDate(dt.getDate() - d);
                return dt.toISOString().split('T')[0];
            };
            const demo = [
                Object.assign({}, defaultStudentData, {
                    id: `s${nextStudentId++}`, lessonPriceUSD:15.00, totalClasses:50,
                    lastClassDate: dateMinusDays(1), registrationDate: dateMinusDays(100),
                    fullName:'Maria Silva', preferredName:'Maria', countryOfOrigin:'Brasil', currentCity:'Rio de Janeiro, Brasil',
                    birthCity:'Rio de Janeiro, Brasil', nativeLanguage:'Português', otherLanguages:'Inglês (C1), Espanhol (B2)',
                    whatsappNumber:'+55 21 98765-4321', level:'C2', motivation:'Aperfeiçoamento contínuo.',
                    currentStateCity: 'Rio de Janeiro, Brasil', currentCountry: 'Brasil', currentLanguage: 'Português',
                    whyStudyingPortuguese: 'Para trabalho', whereStartedLearning: 'Auto-didata', whyChoseTutor: 'Recomendação',
                    hasPartner: 'Sim', partnerName: 'João Silva', hasChildren: 'Sim', numChildren: 2, 
                    childrenNames: ['Ana Silva', 'Pedro Silva'],
                    lessonHistory: [{date: dateMinusDays(1), notes:"Revisão de planejamento.", price:15.00}]
                }),
                Object.assign({}, defaultStudentData, {
                    id: `s${nextStudentId++}`, lessonPriceUSD:8.00, totalClasses:120,
                    lastClassDate: dateMinusDays(5), registrationDate: dateMinusDays(300),
                    fullName:'Norberto Ferreira', preferredName:'Junior', countryOfOrigin:'Portugal', currentCity:'Lisboa, Portugal',
                    birthCity:'Porto, Portugal', nativeLanguage:'Português (PT)', otherLanguages:'Inglês (C2), Francês (B1)',
                    whatsappNumber:'+351 919 123 456', level:'C2', motivation:'Manter a fluência e expandir vocabulário técnico.',
                    currentStateCity: 'Lisboa, Portugal', currentCountry: 'Portugal', currentLanguage: 'Português',
                    whyStudyingPortuguese: 'Interesse cultural', whereStartedLearning: 'Curso online', whyChoseTutor: 'Especialização',
                    hasPartner: 'Não', hasChildren: 'Não',
                    lessonHistory: [{date: dateMinusDays(5), notes:"Revisão geral de gramática.", price:8.00}]
                })
            ];
            STUDENTS = demo;
            saveStudents();
            return STUDENTS;
        }

        // === MENSAGENS E MODAIS ===
        function showMessageBox(title, content, isError = true) {
            const modal = document.getElementById('message-modal');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-title').classList.toggle('text-red-400', isError);
            document.getElementById('message-title').classList.toggle('text-green-400', !isError);
            document.getElementById('message-content').textContent = content;
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeMessageBox() {
            const modal = document.getElementById('message-modal');
            modal.classList.remove('flex'); modal.classList.add('hidden');
        }

        function showDeleteConfirmation(studentId, studentName) {
            const modal = document.getElementById('delete-modal');
            document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir "${studentName}"? Esta ação não pode ser desfeita.`;
            document.getElementById('confirm-delete-button').dataset.studentId = studentId;
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function cancelDelete() {
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('flex'); modal.classList.add('hidden');
            document.getElementById('confirm-delete-button').removeAttribute('data-student-id');
        }
        function confirmDelete() {
            const studentId = document.getElementById('confirm-delete-button').dataset.studentId;
            if (!studentId) return cancelDelete();
            const idx = STUDENTS.findIndex(s => s.id === studentId);
            if (idx !== -1) {
                const name = STUDENTS[idx].fullName;
                STUDENTS.splice(idx,1);
                saveStudents();
                if (SELECTED_STUDENT_ID === studentId) SELECTED_STUDENT_ID = null;
                renderAll(); renderMainPanel();
                showMessageBox("Excluído", `Aluno(a) ${name} removido(a).`, false);
            }
            cancelDelete();
        }

        // === REGISTRO DE AULAS ===
        function openLogClassModal(studentId) {
            const student = STUDENTS.find(s => s.id === studentId);
            if (!student) { showMessageBox("Erro", "Aluno não encontrado.", true); return; }
            document.getElementById('log-student-name').textContent = student.fullName || '—';
            document.getElementById('log-lesson-price').textContent = formatCurrency(student.lessonPriceUSD || 0, 'USD');
            document.getElementById('log-date').value = TODAY.toISOString().split('T')[0];
            document.getElementById('log-notes').value = '';
            document.getElementById('log-class-form').dataset.studentId = studentId;
            const modal = document.getElementById('log-class-modal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeLogClassModal() {
            const modal = document.getElementById('log-class-modal');
            modal.classList.remove('flex'); modal.classList.add('hidden');
            delete document.getElementById('log-class-form').dataset.studentId;
        }
        document.getElementById('log-class-form').onsubmit = (e) => {
            e.preventDefault();
            const studentId = e.target.dataset.studentId;
            const logDate = document.getElementById('log-date').value;
            const logNotes = document.getElementById('log-notes').value.trim();
            logNewClass(studentId, logDate, logNotes);
            closeLogClassModal();
        };

        function logNewClass(studentId, logDate, logNotes) {
            const student = STUDENTS.find(s => s.id === studentId);
            if (!student) { showMessageBox("Erro", "Aluno não encontrado.", true); return; }
            const newLesson = { date: logDate, notes: logNotes, price: student.lessonPriceUSD || 0 };
            student.lessonHistory = student.lessonHistory || [];
            student.lessonHistory.push(newLesson);
            student.totalClasses = student.lessonHistory.length;
            student.lastClassDate = logDate;
            saveStudents();
            renderAll();
            if (SELECTED_STUDENT_ID === studentId) renderMainPanel();
            showMessageBox("Sucesso", `Aula de ${student.fullName} registrada.`, false);
        }

        // === RENDERIZAÇÃO LISTAS E METRICS ===
        function selectStudent(studentId) {
            document.querySelectorAll('.student-item').forEach(el => el.classList.remove('selected'));
            if (SELECTED_STUDENT_ID === studentId || studentId === null) {
                SELECTED_STUDENT_ID = null; renderAll(); renderMainPanel(); return;
            }
            const el = document.getElementById(`student-item-${studentId}`);
            if (el) el.classList.add('selected');
            SELECTED_STUDENT_ID = studentId;
            renderMainPanel();
        }

        function handleNewStudent() {
            SELECTED_STUDENT_ID = 'new';
            renderMainPanel();
        }

        function renderStudentsList() {
            const container = document.getElementById('students-list-container');
            if (!container) return;
            const searchText = (document.getElementById('student-search-input').value || '').toLowerCase();
            const filtered = STUDENTS.filter(st => (st.fullName && st.fullName.toLowerCase().includes(searchText)) || (st.level && st.level.toLowerCase().includes(searchText)))
                .sort((a,b) => (a.fullName||'').localeCompare(b.fullName||''));
            container.innerHTML = '';
            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum aluno encontrado.</p>`;
                document.getElementById('total-students-count').textContent = STUDENTS.length;
                return;
            }
            filtered.forEach(student => {
                const status = getInactivityStatus(student.lastClassDate);
                let statusClass = 'border-gray-600';
                let daysColor = 'text-gray-400';
                if (status === 'Yellow') { statusClass = 'border-l-4 border-yellow-500'; daysColor = 'text-yellow-400'; }
                else if (status === 'Red') { statusClass = 'border-l-4 border-red-500'; daysColor = 'text-red-400'; }
                else if (status === 'Abandoned') { statusClass = 'border-l-4 border-red-700'; daysColor = 'text-red-600'; }

                const daysSince = dateDiffInDays(student.lastClassDate, TODAY.toISOString().split('T')[0]);
                const daysDisplay = daysSince < 30 ? 'Ativo' : `${daysSince}d sem aula`;

                const item = document.createElement('div');
                item.id = `student-item-${student.id}`;
                item.className = `student-item bg-gray-700/60 p-2 rounded-lg cursor-pointer hover:bg-gray-600 transition duration-150 ${statusClass} ${student.id === SELECTED_STUDENT_ID ? 'selected' : ''}`;
                item.onclick = () => selectStudent(student.id);
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-sm truncate text-white">${student.fullName}</p>
                        <span class="text-xs font-bold ${status === 'Active' ? 'text-green-400' : 'text-indigo-400'}">${student.totalClasses || 0} Aulas</span>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <span class="text-xs font-medium text-gray-400 block">${daysDisplay}</span>
                        <span class="text-xs font-semibold ${daysColor}">${student.countryOfOrigin || ''}</span>
                    </div>
                `;
                container.appendChild(item);
            });
            document.getElementById('total-students-count').textContent = STUDENTS.length;
        }

        function renderFinancialMetrics() {
            const metrics = calculateFinancials();
            document.getElementById('metric-total-usd').textContent = formatCurrency(metrics.totalEarnedUSD, 'USD');
            document.getElementById('metric-fee-usd').textContent = formatCurrency(metrics.platformFeeUSD || metrics.platformFeeUSD === 0 ? metrics.platformFeeUSD : metrics.platformFeeUSD, 'USD');
            document.getElementById('metric-net-brl').textContent = formatCurrency(metrics.netBRL, 'BRL');
            document.getElementById('total-classes-count').textContent = metrics.totalClasses;
            renderStudentsList();
        }

        function renderTop10Students() {
            const list = document.getElementById('top-10-list');
            if (!list) return;
            const top = STUDENTS.filter(s => (s.totalClasses||0) > 0).sort((a,b)=> (b.totalClasses||0) - (a.totalClasses||0)).slice(0,10);
            if (top.length === 0) { list.innerHTML = `<p class="text-gray-500 text-center p-2">Nenhum aluno com aulas registradas.</p>`; return; }
            list.innerHTML = top.map((s,i)=>`
                <div class="flex justify-between items-center bg-gray-700/50 p-2 rounded-md hover:bg-gray-600 transition cursor-pointer" onclick="selectStudent('${s.id}')">
                    <span class="font-bold text-indigo-300 mr-2">${i+1}.</span>
                    <span class="flex-grow truncate text-gray-200">${s.fullName}</span>
                    <span class="font-semibold text-green-400 ml-2">${s.totalClasses} Aulas</span>
                </div>
            `).join('');
        }

        function renderInactivityLists() {
            const riskList = document.getElementById('inactivity-risk-list');
            const inactiveList = document.getElementById('inactive-students-list');
            const yellow = STUDENTS.filter(s => getInactivityStatus(s.lastClassDate) === 'Yellow');
            const red = STUDENTS.filter(s => getInactivityStatus(s.lastClassDate) === 'Red');
            const abandoned = STUDENTS.filter(s => getInactivityStatus(s.lastClassDate) === 'Abandoned');

            const render = (arr, color) => {
                if (!arr || arr.length === 0) return `<p class="text-gray-500 text-center p-2">Nenhum aluno nesta categoria.</p>`;
                return arr.map(s=>{
                    const days = dateDiffInDays(s.lastClassDate, TODAY.toISOString().split('T')[0]);
                    return `<div class="flex justify-between items-center bg-gray-700/50 p-2 rounded-md hover:bg-gray-600 transition cursor-pointer" onclick="selectStudent('${s.id}')">
                        <span class="flex-grow truncate text-gray-200">${s.fullName}</span>
                        <span class="font-semibold ${color} ml-2">${days}d</span>
                    </div>`;
                }).join('');
            };

            const allRisk = [...yellow, ...red].sort((a,b)=> dateDiffInDays(a.lastClassDate, TODAY.toISOString().split('T')[0]) - dateDiffInDays(b.lastClassDate, TODAY.toISOString().split('T')[0]));
            riskList.innerHTML = render(allRisk, 'text-orange-400');
            inactiveList.innerHTML = render(abandoned, 'text-red-500');
        }

        function renderAll() {
            renderFinancialMetrics();
            renderTop10Students();
            renderInactivityLists();
            lucide.createIcons();
        }

        // --- PAINEL PRINCIPAL ---
        function renderMainPanel() {
            const mainPanel = document.getElementById('main-panel');
            let content = '';
            let isForm = false;

            if (SELECTED_STUDENT_ID === null) {
                content = renderDashboard();
            } else if (SELECTED_STUDENT_ID === 'new') {
                content = renderStudentForm(Object.assign({}, defaultStudentData, { id: null }));
                isForm = true;
            } else {
                const st = STUDENTS.find(s => s.id === SELECTED_STUDENT_ID);
                if (!st) { content = renderDashboard(); }
                else {
                    if (st.editMode) { content = renderStudentForm(st); isForm = true; }
                    else { content = renderStudentProfile(st); }
                }
            }

            mainPanel.innerHTML = content;
            if (!metricsVisible) document.querySelectorAll('.monetary-value').forEach(el=>el.classList.add('hidden'));
            else document.querySelectorAll('.monetary-value').forEach(el=>el.classList.remove('hidden'));
            lucide.createIcons();
            if (isForm) setupConditionalFields();
        }

        function renderDashboard() {
            const metrics = calculateFinancials();
            const totalEarnedUSD = metrics.totalEarnedUSD, netBRL = metrics.netBRL, totalClasses = metrics.totalClasses;
            const dataClassesByMotivation = STUDENTS.reduce((acc, s)=>{ if(s.motivation){ const k=s.motivation.split(',')[0].trim(); acc[k]=(acc[k]||0)+(s.totalClasses||0); } return acc; }, {});
            const studentsByCountry = STUDENTS.reduce((acc,s)=>{ if(s.countryOfOrigin){ const c=s.countryOfOrigin.split(',')[0].trim(); acc[c]=(acc[c]||0)+1; } return acc; }, {});

            return `
                <div class="space-y-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold text-teal-400 mb-3 flex items-center">
                            <i data-lucide="compass" class="w-5 h-5 mr-2"></i> Resumo Rápido e Métricas Chave
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-700/50 p-4 rounded-lg">
                            <div class="text-center">
                                <p class="text-xs text-gray-400">Faturamento Bruto (USD)</p>
                                <span class="text-lg font-extrabold text-green-400 monetary-value">${formatCurrency(totalEarnedUSD, 'USD')}</span>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-400">Faturamento Líquido (BRL)</p>
                                <span class="text-lg font-extrabold text-teal-400 monetary-value">${formatCurrency(netBRL, 'BRL')}</span>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-400">Alunos Abandonados (90+ dias)</p>
                                <span class="text-lg font-extrabold text-red-400">${STUDENTS.filter(s => getInactivityStatus(s.lastClassDate) === 'Abandoned').length}</span>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-400">Média de Aulas por Aluno</p>
                                <span class="text-lg font-extrabold text-indigo-400">${(STUDENTS.length > 0 ? (totalClasses / STUDENTS.length).toFixed(1) : 0)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-900 p-4 rounded-lg border border-gray-800">
                            ${renderProportionChart(dataClassesByMotivation, 'Total de Aulas por Motivação', 'Aulas')}
                        </div>
                        <div id="country-chart-container" class="bg-gray-900 p-4 rounded-lg border border-gray-800">
                            ${renderProportionChart(studentsByCountry, 'Alunos por País de Origem', 'Alunos')}
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold text-indigo-400 mb-4 flex items-center">
                            <i data-lucide="history" class="w-5 h-5 mr-2"></i> Histórico Recente de Aulas
                        </h2>
                        ${STUDENTS.filter(s => Array.isArray(s.lessonHistory) && s.lessonHistory.length>0).sort((a,b)=> dateDiffInDays(b.lastClassDate,a.lastClassDate)).slice(0,5).map(s=>{
                            const last = s.lessonHistory.slice(-1)[0];
                            return `<div class="mb-3 p-3 bg-gray-700/50 rounded-lg border-l-4 border-green-500">
                                <p class="font-bold text-gray-200">${s.fullName} <span class="text-xs font-normal text-gray-400 ml-2">(${formatDate(last.date)})</span></p>
                                <p class="text-sm text-gray-300 truncate">${last.notes || 'Nenhuma anotação registrada.'}</p>
                            </div>`;
                        }).join('') || `<p class="text-gray-500 text-center p-2">Nenhuma aula registrada ainda.</p>`}
                    </div>
                </div>
            `;
        }

        function renderProportionChart(dataObject, title, valueLabel) {
            const total = Object.values(dataObject).reduce((s,v)=> s + (v||0), 0);
            if (total === 0) return `<div class="text-center text-gray-500 p-4">Nenhum dado para mostrar.</div>`;
            const colors = ['#818CF8','#10B981','#F59E0B','#EF4444','#6B72B0','#06B6D4','#F472B6','#EAB308','#22C55E','#A855F7'];
            const segments = Object.entries(dataObject).sort(([,a],[,b]) => b - a).map(([label, value], index) => {
                const percentage = (value / total) * 100;
                const color = colors[index % colors.length];
                return { label, percentage: percentage.toFixed(1), color, value };
            });
            let start = 0;
            const pieSegments = segments.map(seg => {
                const angle = seg.percentage * 3.6;
                const s = start;
                const e = Math.min(360, start + angle);
                start = e;
                return { ...seg, start: s, end: e };
            });
            const conicGradient = pieSegments.map(s => `${s.color} ${s.start}deg ${s.end}deg`).join(', ');
            return `
                <h3 class="text-lg font-semibold text-gray-200 mb-4 border-b border-gray-700 pb-2">${title}</h3>
                <div class="flex flex-col lg:flex-row items-center lg:items-start space-y-4 lg:space-y-0 lg:space-x-6">
                    <div class="flex-shrink-0 w-32 h-32 md:w-40 md:h-40 relative rounded-full shadow-lg border-4 border-gray-800" style="background: conic-gradient(${conicGradient});">
                        <div class="absolute inset-4 rounded-full bg-gray-900 flex items-center justify-center text-md md:text-xl font-bold text-indigo-400">
                            ${total.toLocaleString('pt-BR')} ${valueLabel.split(' ')[0]}
                        </div>
                    </div>
                    <div class="flex-grow mt-4 space-y-2 text-xs md:text-sm custom-scroll max-h-40 overflow-y-auto w-full lg:w-auto">
                        ${segments.map(s => `
                            <p class="flex justify-between items-center text-gray-300">
                                <span class="flex items-center">
                                    <span style="background-color: ${s.color};" class="w-3 h-3 rounded-full mr-2 flex-shrink-0"></span>
                                    ${s.label}
                                </span>
                                <span class="font-bold text-right text-indigo-300">${s.value.toLocaleString('pt-BR')}
                                    <span class="text-gray-400 ml-1">(${s.percentage}%)</span>
                                </span>
                            </p>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // === FORMULÁRIO DO ALUNO (salvar / editar) ===
        function renderStudentForm(student) {
            const isEdit = !!student.id;
            const title = isEdit ? `Editar Cadastro: ${student.fullName || ''}` : 'Novo Aluno';
            const getVal = (k) => (student[k] !== undefined && student[k] !== null) ? student[k] : '';
            const levelOptions = Object.keys(LEVEL_DESCRIPTIONS).map(level => {
                const value = `${level} – ${LEVEL_DESCRIPTIONS[level]}`;
                const selected = student.level === level ? 'selected' : '';
                return `<option value="${value}" ${selected}>${value}</option>`;
            }).join('');

            return `
                <div class="panel-bg p-6 md:p-8 rounded-xl shadow-2xl border border-gray-700">
                    <div class="flex justify-between items-start border-b border-gray-700 pb-4 mb-6">
                        <h1 class="text-xl md:text-3xl font-extrabold primary-color">${title}</h1>
                        <div class="flex space-x-2">
                            <button onclick="selectStudent(null)" title="Voltar para Dashboard" class="flex items-center bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-3 rounded-lg font-semibold transition duration-200 text-sm flex-shrink-0">
                                <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> Dashboard
                            </button>
                        </div>
                    </div>

                    <form id="student-form" onsubmit="saveStudent(event)">
                        <input type="hidden" name="id" value="${student.id ? student.id : ''}">
                        <input type="hidden" name="registrationDate" value="${student.registrationDate || TODAY.toISOString().split('T')[0]}">

                        <div class="grid grid-cols-2 gap-4 mb-6 p-4 border border-indigo-700 rounded-lg">
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mb-1">Preço da Aula (USD)</label>
                                <input type="number" step="0.01" name="lessonPriceUSD" value="${getVal('lessonPriceUSD')}" min="0.01" required class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mb-1">Total de Aulas Registradas</label>
                                <input type="number" name="totalClasses" value="${getVal('totalClasses')}" min="0" class="form-input-style" ${isEdit ? '' : 'readonly title="Só é alterado pelo registro de aula"'}>
                            </div>
                        </div>

                        <h2 class="text-xl font-semibold text-indigo-400 mb-2">👤 Informações Básicas</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Nome Completo:</label>
                                <input type="text" name="nome" value="${getVal('fullName')}" required class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Como prefere ser chamado(a):</label>
                                <input type="text" name="apelido" value="${getVal('preferredName')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">País de origem:</label>
                                <input type="text" name="pais_origem" list="country-list" value="${getVal('countryOfOrigin')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Cidade natal:</label>
                                <input type="text" name="cidade_natal" list="city-list" value="${getVal('birthCity')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Onde mora atualmente:</label>
                                <input type="text" name="local_atual" list="city-list" value="${getVal('currentCity')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Idioma nativo:</label>
                                <input type="text" name="idioma_nativo" list="language-list" value="${getVal('nativeLanguage')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Outros idiomas que fala:</label>
                                <input type="text" name="idiomas_outros" value="${getVal('otherLanguages')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">WhatsApp:</label>
                                <input type="text" name="whatsapp_numero" value="${getVal('whatsappNumber')}" class="form-input-style">
                            </div>
                            <!-- NOVOS CAMPOS ADICIONADOS -->
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Estado/Cidade atual:</label>
                                <input type="text" name="current_state_city" list="city-list" value="${getVal('currentStateCity')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Casado(a)?</label>
                                <select name="has_partner" class="form-input-style" onchange="togglePartnerField(this)">
                                    <option value="Não" ${getVal('hasPartner') === 'Não' ? 'selected' : ''}>Não</option>
                                    <option value="Sim" ${getVal('hasPartner') === 'Sim' ? 'selected' : ''}>Sim</option>
                                </select>
                            </div>
                            <div id="partnerNameField" class="${getVal('hasPartner') === 'Sim' ? '' : 'hidden'}">
                                <label class="block text-sm text-gray-400 font-medium mt-3">Nome do cônjuge:</label>
                                <input type="text" name="partner_name" value="${getVal('partnerName')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Tem filho(s)?</label>
                                <select name="has_children" class="form-input-style" onchange="toggleChildrenFields(this)">
                                    <option value="Não" ${getVal('hasChildren') === 'Não' ? 'selected' : ''}>Não</option>
                                    <option value="Sim" ${getVal('hasChildren') === 'Sim' ? 'selected' : ''}>Sim</option>
                                </select>
                            </div>
                            <div id="childrenFields" class="${getVal('hasChildren') === 'Sim' ? '' : 'hidden'} md:col-span-2">
                                <div class="mb-3">
                                    <label class="block text-sm text-gray-400 font-medium mb-1">Quantidade de filhos:</label>
                                    <div class="number-input-container">
                                        <button type="button" class="number-input-btn" onclick="changeChildrenCount(-1)">-</button>
                                        <input type="number" name="num_children" value="${getVal('numChildren') || 0}" min="0" class="form-input-style number-input" onchange="updateChildrenNames()">
                                        <button type="button" class="number-input-btn" onclick="changeChildrenCount(1)">+</button>
                                    </div>
                                </div>
                                <div id="childrenNamesContainer" class="space-y-2">
                                    ${(student.childrenNames && student.childrenNames.length > 0 ? student.childrenNames.map((name, index) => `
                                        <div>
                                            <label class="block text-sm text-gray-400 font-medium mb-1">Nome do filho ${index + 1}:</label>
                                            <input type="text" name="child_name_${index}" value="${name}" class="form-input-style">
                                        </div>
                                    `).join('') : '')}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">País atual:</label>
                                <input type="text" name="current_country" list="country-list" value="${getVal('currentCountry')}" class="form-input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Idioma atual que fala:</label>
                                <input type="text" name="current_language" list="language-list" value="${getVal('currentLanguage')}" class="form-input-style">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm text-gray-400 font-medium mt-3">Por que está estudando português:</label>
                                <textarea name="why_studying_portuguese" rows="2" class="form-input-style">${getVal('whyStudyingPortuguese')}</textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm text-gray-400 font-medium mt-3">Onde começou a aprender português:</label>
                                <textarea name="where_started_learning" rows="2" class="form-input-style">${getVal('whereStartedLearning')}</textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm text-gray-400 font-medium mt-3">Por que escolheu este tutor:</label>
                                <textarea name="why_chose_tutor" rows="2" class="form-input-style">${getVal('whyChoseTutor')}</textarea>
                            </div>
                        </div>

                        <hr class="border-gray-700 mt-6">
                        <h2 class="text-xl font-semibold text-indigo-400 mt-4 mb-2">💬 Preferências e Objetivos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Nível atual de português</label>
                                <select name="nivel_portugues" class="form-input-style">
                                    <option value="">Selecione</option>
                                    ${levelOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 font-medium mt-3">Motivação (breve)</label>
                                <input type="text" name="motivo" value="${getVal('motivation')}" class="form-input-style">
                            </div>
                        </div>

                        <hr class="border-gray-700 mt-6">
                        <h2 class="text-xl font-semibold text-indigo-400 mt-4 mb-2">📝 Anotações do Professor</h2>
                        <div>
                            <label class="block text-sm text-gray-400 font-medium mt-3">Gostaria de compartilhar algo mais sobre você?</label>
                            <textarea name="extra" rows="3" class="form-input-style">${getVal('openSpace')}</textarea>
                        </div>

                        <div class="mt-8 flex justify-end space-x-3 border-t border-gray-700 pt-4">
                            <button type="submit" class="primary-bg primary-hover-bg text-white py-2.5 px-6 rounded-lg font-bold transition duration-200 shadow-lg flex items-center">
                                <i data-lucide="save" class="w-5 h-5 mr-2"></i> Salvar Cadastro
                            </button>
                            ${isEdit ? `<button type="button" onclick="showDeleteConfirmation('${student.id}', '${(student.fullName||'').replace("'", "\\'")}')" class="bg-red-600 hover:bg-red-500 text-white py-2.5 px-6 rounded-lg font-bold transition duration-200 shadow-lg flex items-center"><i data-lucide="trash-2" class="w-5 h-5 mr-2"></i> Excluir Aluno</button>` : ''}
                        </div>
                    </form>
                </div>
            `;
        }

        // Funções para campos dinâmicos
        function togglePartnerField(select) {
            const partnerField = document.getElementById('partnerNameField');
            if (select.value === 'Sim') {
                partnerField.classList.remove('hidden');
            } else {
                partnerField.classList.add('hidden');
            }
        }

        function toggleChildrenFields(select) {
            const childrenFields = document.getElementById('childrenFields');
            if (select.value === 'Sim') {
                childrenFields.classList.remove('hidden');
                updateChildrenNames();
            } else {
                childrenFields.classList.add('hidden');
            }
        }

        function changeChildrenCount(delta) {
            const input = document.querySelector('input[name="num_children"]');
            let value = parseInt(input.value) || 0;
            value += delta;
            if (value < 0) value = 0;
            input.value = value;
            updateChildrenNames();
        }

        function updateChildrenNames() {
            const container = document.getElementById('childrenNamesContainer');
            const numChildren = parseInt(document.querySelector('input[name="num_children"]').value) || 0;
            
            container.innerHTML = '';
            for (let i = 0; i < numChildren; i++) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-sm text-gray-400 font-medium mb-1">Nome do filho ${i + 1}:</label>
                    <input type="text" name="child_name_${i}" class="form-input-style">
                `;
                container.appendChild(div);
            }
        }

        function setupConditionalFields() {
            // Já configurado via onchange nos elementos
        }

        function renderStudentProfile(student) {
            const getDisplay = (key, val) => {
                if (Array.isArray(val)) return val.length ? val.join(', ') : 'N/A';
                if (!val) return 'N/A';
                if (key === 'level') return `${val} – ${LEVEL_DESCRIPTIONS[val] || 'Nível não definido'}`;
                return val;
            };

            const lessonsHTML = (student.lessonHistory || []).length > 0 ? 
                student.lessonHistory.map(lesson => `
                    <div class="mb-3 p-3 bg-gray-700/50 rounded-lg border-l-4 border-green-500">
                        <div class="flex justify-between items-start mb-1">
                            <strong class="text-white">${formatDate(lesson.date)}</strong>
                            <span class="text-green-400 font-bold">${formatCurrency(lesson.price || 0,'USD')}</span>
                        </div>
                        <p class="text-sm text-gray-300 mt-1">${lesson.notes || 'Sem anotações'}</p>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center p-4 bg-gray-700/30 rounded-lg">Nenhuma aula registrada ainda.</p>';

            return `
                <div class="panel-bg p-6 md:p-8 rounded-xl shadow-2xl border border-gray-700">
                    <div class="flex justify-between items-start border-b border-gray-700 pb-4 mb-6">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-extrabold text-white">${student.fullName || '—'}</h1>
                            <p class="text-sm text-gray-400 mt-1">${student.preferredName ? 'Como prefere ser chamado(a): ' + student.preferredName : ''}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Última aula</p>
                            <p class="text-lg font-bold text-green-400">${formatDate(student.lastClassDate)}</p>
                            <p class="text-xs text-gray-400 mt-1">Total de aulas: <span class="font-bold text-indigo-300">${student.totalClasses || 0}</span></p>
                            <p class="text-xs text-gray-400">Preço da aula: <span class="font-bold text-green-400">${formatCurrency(student.lessonPriceUSD || 0, 'USD')}</span></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Coluna 1: Informações Pessoais -->
                        <div class="space-y-6">
                            <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600">
                                <h3 class="text-lg font-semibold text-indigo-400 mb-3 flex items-center">
                                    <i data-lucide="user" class="w-5 h-5 mr-2"></i> Informações Pessoais
                                </h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">País de origem</label>
                                        <p class="text-white font-medium">${getDisplay('countryOfOrigin', student.countryOfOrigin)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Cidade natal</label>
                                        <p class="text-white font-medium">${getDisplay('birthCity', student.birthCity)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Onde mora atualmente</label>
                                        <p class="text-white font-medium">${getDisplay('currentCity', student.currentCity)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Estado/Cidade atual</label>
                                        <p class="text-white font-medium">${getDisplay('currentStateCity', student.currentStateCity)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Idioma nativo</label>
                                        <p class="text-white font-medium">${getDisplay('nativeLanguage', student.nativeLanguage)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Outros idiomas</label>
                                        <p class="text-white font-medium">${getDisplay('otherLanguages', student.otherLanguages)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Casado(a)?</label>
                                        <p class="text-white font-medium">${student.hasPartner === 'Sim' ? `Sim - ${student.partnerName || 'Nome não informado'}` : 'Não'}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Tem filhos?</label>
                                        <p class="text-white font-medium">${student.hasChildren === 'Sim' ? (student.childrenNames && student.childrenNames.length > 0 ? student.childrenNames.join(', ') : 'Nomes não informados') : 'Não'}</p>
                                    </div>
                                    ${student.whatsappNumber ? `
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">WhatsApp</label>
                                        <p class="text-white font-medium"><a href="https://wa.me/${student.whatsappNumber.replace(/\D/g, '')}" target="_blank" class="text-green-400 hover:text-green-300">${student.whatsappNumber}</a></p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600">
                                <h3 class="text-lg font-semibold text-indigo-400 mb-3 flex items-center">
                                    <i data-lucide="target" class="w-5 h-5 mr-2"></i> Objetivos e Motivação
                                </h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Nível atual de português</label>
                                        <p class="text-white font-medium">${getDisplay('level', student.level)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Motivação</label>
                                        <p class="text-white font-medium">${getDisplay('motivation', student.motivation)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Por que está estudando português</label>
                                        <p class="text-white font-medium">${getDisplay('whyStudyingPortuguese', student.whyStudyingPortuguese)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Onde começou a aprender</label>
                                        <p class="text-white font-medium">${getDisplay('whereStartedLearning', student.whereStartedLearning)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Por que escolheu este tutor</label>
                                        <p class="text-white font-medium">${getDisplay('whyChoseTutor', student.whyChoseTutor)}</p>
                                    </div>
                                    ${student.studiedBefore ? `
                                    <div>
                                        <label class="block text-sm text-gray-400 font-medium">Como começou a estudar português</label>
                                        <p class="text-white font-medium">${student.studiedBefore}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Coluna 2: Histórico de Aulas -->
                        <div class="space-y-6">
                            <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600">
                                <h3 class="text-lg font-semibold text-indigo-400 mb-3 flex items-center">
                                    <i data-lucide="history" class="w-5 h-5 mr-2"></i> Histórico de Aulas
                                </h3>
                                <div class="max-h-80 overflow-y-auto custom-scroll">
                                    ${lessonsHTML}
                                </div>
                            </div>

                            ${student.openSpace ? `
                            <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600">
                                <h3 class="text-lg font-semibold text-indigo-400 mb-3 flex items-center">
                                    <i data-lucide="sticky-note" class="w-5 h-5 mr-2"></i> Anotações Adicionais
                                </h3>
                                <p class="text-white">${student.openSpace}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="mt-8 flex space-x-3 justify-end border-t border-gray-700 pt-6">
                        <button class="bg-green-600 hover:bg-green-500 text-white py-2.5 px-6 rounded-lg font-semibold transition duration-200 shadow-lg flex items-center" onclick="openLogClassModal('${student.id}')">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Registrar Aula
                        </button>
                        <button class="bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 px-6 rounded-lg font-semibold transition duration-200 shadow-lg flex items-center" onclick="enableEditMode('${student.id}')">
                            <i data-lucide="edit-3" class="w-5 h-5 mr-2"></i> Editar Cadastro
                        </button>
                        <button class="bg-red-600 hover:bg-red-500 text-white py-2.5 px-6 rounded-lg font-semibold transition duration-200 shadow-lg flex items-center" onclick="showDeleteConfirmation('${student.id}', '${(student.fullName||'').replace("'", "\\'")}')">
                            <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i> Excluir Aluno
                        </button>
                        <button class="bg-gray-600 hover:bg-gray-500 text-white py-2.5 px-6 rounded-lg font-semibold transition duration-200 shadow-lg flex items-center" onclick="selectStudent(null)">
                            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2"></i> Dashboard
                        </button>
                    </div>
                </div>
            `;
        }

        function enableEditMode(studentId) {
            const s = STUDENTS.find(x=>x.id===studentId);
            if (!s) { showMessageBox("Erro","Aluno não encontrado.", true); return; }
            s.editMode = true;
            SELECTED_STUDENT_ID = studentId;
            renderMainPanel();
        }

        // === salvar aluno (criar/editar) ===
        async function saveStudent(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const mapping = {
                nome:'fullName', apelido:'preferredName', pais_origem:'countryOfOrigin', cidade_natal:'birthCity',
                local_atual:'currentCity', idioma_nativo:'nativeLanguage', idiomas_outros:'otherLanguages',
                whatsapp_numero:'whatsappNumber', telefone_numero:'phoneNumber', nivel_portugues:'level',
                experiencia_portugues:'studiedBefore', motivo:'motivation', objetivo:'mainGoal',
                uso_portugues:'portugueseUse', profissao:'occupation', local_trabalho:'workplace',
                experiencias_profissionais:'previousJobs', 
                // NOVOS CAMPOS
                current_state_city:'currentStateCity', has_partner:'hasPartner', partner_name:'partnerName',
                has_children:'hasChildren', num_children:'numChildren', current_country:'currentCountry',
                current_language:'currentLanguage', why_studying_portuguese:'whyStudyingPortuguese',
                where_started_learning:'whereStartedLearning', why_chose_tutor:'whyChoseTutor',
                // Campos originais
                lessonPriceUSD:'lessonPriceUSD', totalClasses:'totalClasses', lastClassDate:'lastClassDate',
                id:'id', registrationDate:'registrationDate', hasHobby:'hasHobby', extra:'openSpace'
            };

            const studentData = Object.assign({}, defaultStudentData);
            studentData.childrenNames = []; studentData.petsNames = [];
            formData.forEach((value, key) => {
                const newKey = mapping[key] || key;
                if (['lessonPriceUSD','totalClasses','numChildren','numPets'].includes(newKey)) {
                    studentData[newKey] = parseFloat(value) || 0;
                } else if (newKey === 'level' && String(value).includes('–')) {
                    studentData[newKey] = String(value).split('–')[0].trim();
                } else if (key.startsWith('child_name_')) {
                    if (String(value).trim()) studentData.childrenNames.push(String(value).trim());
                } else if (key.startsWith('petName_')) {
                    if (String(value).trim()) studentData.petsNames.push(String(value).trim());
                } else {
                    studentData[newKey] = String(value).trim();
                }
            });

            if (!studentData.fullName) { showMessageBox("Erro de Validação","O campo 'Nome Completo' é obrigatório.", true); return; }

            studentData.numChildren = parseInt(studentData.numChildren) || (studentData.childrenNames.length||0);
            studentData.numPets = parseInt(studentData.numPets) || (studentData.petsNames.length||0);
            if (!studentData.id) {
                // novo
                studentData.id = `s${nextStudentId++}`;
                studentData.registrationDate = studentData.registrationDate || TODAY.toISOString().split('T')[0];
                studentData.lastClassDate = studentData.lastClassDate || TODAY.toISOString().split('T')[0];
                studentData.lessonHistory = studentData.lessonHistory || [];
                studentData.editMode = false;
                STUDENTS.push(studentData);
                showMessageBox("Sucesso", `Novo aluno(a) ${studentData.fullName} adicionado.`, false);
            } else {
                // editar existente
                const idx = STUDENTS.findIndex(s => s.id === studentData.id);
                if (idx !== -1) {
                    studentData.lessonHistory = STUDENTS[idx].lessonHistory || studentData.lessonHistory || [];
                    studentData.editMode = false;
                    STUDENTS[idx] = Object.assign({}, STUDENTS[idx], studentData);
                    showMessageBox("Sucesso", `Cadastro de ${studentData.fullName} atualizado.`, false);
                } else {
                    // se id informado mas não encontrado, crie novo mesmo
                    studentData.id = `s${nextStudentId++}`;
                    STUDENTS.push(studentData);
                    showMessageBox("Sucesso", `Novo aluno(a) ${studentData.fullName} adicionado.`, false);
                }
            }

            await saveStudents();
            SELECTED_STUDENT_ID = studentData.id;
            renderAll(); renderMainPanel();
        }

        // === import / export ===
        function exportData() {
            const data = { students: STUDENTS, nextId: nextStudentId, exchangeRate: EXCHANGE_RATE, exportDate: new Date().toISOString() };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `italki_dashboard_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessageBox("Exportação Concluída", "Os dados foram baixados com sucesso!", false);
        }

        function importData() { document.getElementById('import-file-input').click(); }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!imported.students || !Array.isArray(imported.students)) throw new Error("Arquivo inválido: chave 'students' não encontrada.");
                    // normaliza cada registro
                    STUDENTS = imported.students.map(s => Object.assign({}, defaultStudentData, s));
                    // calcula nextId
                    const maxId = STUDENTS.reduce((m, s) => {
                        const n = parseInt((s.id || 's0').replace(/^s/,'') || 0);
                        return isNaN(n) ? m : Math.max(m, n);
                    }, 0);
                    nextStudentId = Math.max(nextStudentId, maxId + 1);
                    if (imported.exchangeRate) EXCHANGE_RATE = parseFloat(imported.exchangeRate) || EXCHANGE_RATE;
                    document.getElementById('exchange-rate-input').value = EXCHANGE_RATE.toFixed(2);
                    saveStudents();
                    SELECTED_STUDENT_ID = null; renderAll(); renderMainPanel();
                    showMessageBox("Importação Concluída", `Foram importados ${STUDENTS.length} registros com sucesso!`, false);
                } catch (err) {
                    console.error("Erro import:", err);
                    showMessageBox("Erro de Importação", "Não foi possível processar o arquivo. Verifique o formato.", true);
                }
            };
            reader.readAsText(file);
        }

        // === outras utilidades ===
        function updateExchangeRateFromInput() {
            const v = parseFloat(document.getElementById('exchange-rate-input').value);
            if (!isNaN(v) && v > 0) {
                EXCHANGE_RATE = v;
                saveStudents();
                renderFinancialMetrics();
                showMessageBox("Câmbio Atualizado", `Taxa USD/BRL atualizada para ${v.toFixed(2)}.`, false);
            } else {
                showMessageBox("Erro de Câmbio", "Insira uma taxa válida.", true);
            }
        }

        function toggleMetricsVisibility() {
            metricsVisible = !metricsVisible;
            const iconEl = document.getElementById('toggle-metrics-icon');
            if (!metricsVisible) { document.querySelectorAll('.monetary-value').forEach(el=>el.classList.add('hidden')); iconEl.setAttribute('data-lucide','eye-off'); }
            else { document.querySelectorAll('.monetary-value').forEach(el=>el.classList.remove('hidden')); iconEl.setAttribute('data-lucide','eye'); }
            lucide.createIcons();
        }

        function createDatalist(id, data) {
            // remove se já existe
            const old = document.getElementById(id);
            if (old) old.remove();
            const dl = document.createElement('datalist'); dl.id = id;
            data.forEach(item => { const o = document.createElement('option'); o.value = item; dl.appendChild(o); });
            document.body.appendChild(dl);
        }

        // liga botões de login quando a página carregar
        document.getElementById('google-login-btn').onclick = handleGoogleLogin;
        document.getElementById('logout-btn').onclick = handleLogout;

        // Proteção leve contra inspeção (mantive, você tinha)
        document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
        document.addEventListener('keydown', function(e) {
            // permite teclas normais, mas evita abrir devtools com F12
            if (e.key === 'F12') e.preventDefault();
        });

        // Inicialização: se já estiver logado pelo Firebase, inicializa
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                initUserDashboard();
            } else {
                // nada
            }
        });

        // carregamento inicial (se localStorage tiver dados, será carregado ao iniciar o dashboard)
        (async () => {
            await loadStudents();
            renderAll();
            renderMainPanel();
        })();

    </script>

</body>
</html>