<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gerencial - Funcionalidade</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos de Tema */
        body { background-color: #0F172A; margin: 0; font-family: 'Inter', sans-serif; }
        .panel { background-color: #1E293B; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; color: #E2E8F0; }
        .placeholder-text { color: #94A3B8; font-style: italic; font-size: 0.8rem; text-align: center; padding: 1rem 0; }
        
        .custom-button { transition: background-color 0.2s, transform 0.1s; }
        .custom-button:hover { transform: translateY(-1px); }
        
        /* Modal Customizado (Para Confirmação de Exclusão) */
        #custom-modal { background-color: rgba(0, 0, 0, 0.7); z-index: 50; }
        .modal-content { background-color: #1E293B; border: 1px solid #334155; }
        
        /* Regra que garante a altura mínima da tela para o layout principal (vh-screen) */
        #dashboard-view {
            min-height: calc(100vh - 84px); /* Altura da tela menos a altura do cabeçalho */
        }
        
        /* 1. COLUNAS PRIMÁRIAS (Esquerda e Direita) - Devem ser containers flexíveis verticais */
        #coluna-esquerda, #coluna-direita {
            display: flex;
            flex-direction: column;
            height: 100%; /* Pega a altura total de #dashboard-view */
        }

        /* 2. LISTA GERAL DE ALUNOS (#lista-alunos-geral) - Deve crescer para ocupar o espaço */
        #lista-alunos-geral {
            flex-grow: 1; 
            overflow-y: auto; /* Permite scroll se a lista for muito maior que a altura da coluna */
            padding-top: 0.5rem;
        }
        
        /* 3. LISTAS DE RANKING: Estilos Específicos para Mobile */
        /* Para telas pequenas, as listas de rank precisam de uma altura máxima para não estourar */
        .rank-list-mobile-constrain {
             max-height: 25vh; /* Limite de altura para telas pequenas */
             overflow-y: auto;
        }

        /* 4. LISTAS DE RANKING: Estilos Específicos para Desktop (MÉDIA E ACIMA) */
        @media (min-width: 768px) { /* Equivalente ao breakpoint 'md' do Tailwind */
            
            /* Os painéis de lista internos (Top 10, Ausentes, Risco) devem crescer */
            #lista-top-10, 
            #listas-risco > div { 
                flex-grow: 1;
                display: flex; /* Transforma em container flexível */
                flex-direction: column;
                /* Assegura que o UL interno use a altura disponível */
                max-height: 100%;
            }

            /* O UL real (lista) deve crescer sem limites ou barras internas */
            .rank-list-stretch {
                flex-grow: 1;
                overflow-y: visible !important; /* MANTÉM VISÍVEL (SEM SCROLL INTERNO) */
                max-height: none !important; /* REMOVE O LIMITE DE ALTURA */
            }

            /* #listas-risco precisa distribuir o espaço entre os sub-painéis */
            #listas-risco {
                display: flex;
                flex-direction: column;
                flex-grow: 1;
                gap: 0.75rem; /* Espaçamento entre os painéis de risco */
            }
        }
    </style>
</head>
<body class="p-0">

    <!-- A. CABEÇALHO (Botão Adicionar Aluno REMOVIDO) -->
    <header class="w-full flex justify-center bg-slate-900 border-b border-slate-700 p-4 sticky top-0 z-20">
        <div class="w-full flex justify-between items-center max-w-7xl">
            <!-- Seu Cabeçalho Colado Aqui -->
            <div class="text-xl text-indigo-400 font-bold flex items-center">
                <i data-lucide="layout-dashboard" class="w-6 h-6 mr-2"></i> Dashboard de Alunos
            </div>
            
            <!-- Apenas um placeholder de espaço no lado direito onde estava o botão -->
            <div class="w-6 h-6"></div> 
        </div>
    </header>

    <!-- B. CORPO PRINCIPAL -->
    <main class="w-full p-4 sm:p-8 max-w-7xl mx-auto"> 

        <!-- 1. DASHBOARD VIEW (Visível por padrão) -->
        <div id="dashboard-view" class="flex flex-col md:flex-row gap-6">

            <!-- B.1 COLUNA ESQUERDA (Lista de Alunos / Mobile Primary View) -->
            <section id="coluna-esquerda" class="w-full md:w-1/4 panel order-2 md:order-1">
                <div class="flex justify-between items-center border-b border-indigo-600 pb-2 mb-4 flex-shrink-0">
                    <h3 class="text-lg font-bold text-indigo-400">Lista de Alunos</h3>
                    <!-- Métrica Total de Alunos e Aulas -->
                    <div id="total-alunos-aulas" class="flex items-center space-x-3 text-sm font-medium text-slate-300">
                        <!-- Será preenchido pelo JS -->
                    </div>
                </div>
                
                <!-- Campo de Busca -->
                <div class="mb-4 relative flex-shrink-0">
                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                    <input type="text" onkeyup="filtrarAlunos(this.value)" placeholder="Buscar por Nome..." class="w-full p-2 pl-10 text-sm bg-slate-700 border border-slate-600 rounded-md text-slate-200 placeholder-slate-400 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Lista de Alunos (flex-grow: 1 no CSS) -->
                <div id="lista-alunos-geral" class="space-y-2">
                    <p class="placeholder-text">Lista de alunos será renderizada aqui...</p>
                </div>
            </section>

            <!-- B.2 COLUNA CENTRAL (Gráficos e Últimas Aulas) -->
            <section id="coluna-centro" class="hidden md:block w-full md:w-1/2 panel order-1 md:order-2">
                <h3 class="text-xl font-bold text-yellow-400 border-b border-yellow-600 pb-2 mb-4">
                    Gráficos e Métricas
                </h3>
                 <div id="metricas-e-graficos">
                    <p class="placeholder-text">Gráficos Donut (Engajamento e Nível).</p>
                    
                    <!-- Últimas 5 Aulas Registradas -->
                    <div class="mt-8">
                        <h4 class="text-lg font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-3">Últimas 5 Aulas Registradas</h4>
                        <ul id="ultimas-aulas-list" class="space-y-1 text-sm">
                            <li class="text-slate-400">Nenhuma aula recente...</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- B.3 COLUNA DIREITA (Rankings e Import/Export) -->
            <!-- #coluna-direita agora é um flex container vertical para distribuir o espaço -->
            <section id="coluna-direita" class="hidden md:flex w-full md:w-1/4 panel order-3"> 
                
                <h3 class="text-lg font-bold text-orange-400 border-b border-orange-600 pb-2 mb-4 flex-shrink-0">
                    Gestão de Engajamento
                </h3>
                
                <!-- LISTA TOP 10 (flex-grow: 1 em desktop no CSS) -->
                <div id="lista-top-10" class="panel bg-slate-700/50 p-2 mb-3 md:mb-0">
                    <h4 class="font-bold text-yellow-300 flex-shrink-0">Top 10 Engajamento</h4>
                    <!-- 'rank-list-stretch' faz crescer em desktop; 'rank-list-mobile-constrain' limita em mobile -->
                    <ul id="top-10-alunos-list" class="rank-list-stretch rank-list-mobile-constrain text-sm"></ul>
                </div>
                
                <!-- LISTAS DE RISCO E AUSENTES (flex-grow: 1 em desktop no CSS) -->
                <div id="listas-risco" class="space-y-3 md:flex-grow md:flex md:flex-col md:gap-3">
                    
                    <!-- AUSENTES (1-30 dias) -->
                    <div class="bg-slate-700/50 p-2 rounded-md">
                        <h4 class="font-bold text-yellow-400 flex-shrink-0">Ausentes (1-30 dias)</h4>
                         <!-- 'rank-list-stretch' faz crescer em desktop -->
                        <ul id="ausentes-alunos-list" class="rank-list-stretch rank-list-mobile-constrain text-sm"></ul>
                    </div>
                    
                    <!-- RISCO CRÍTICO (31-90 dias) - TEXTO ALTERADO AQUI -->
                     <div class="bg-slate-700/50 p-2 rounded-md">
                        <h4 class="font-bold text-red-500 flex-shrink-0">Risco Crítico (31-90 dias)</h4>
                        <!-- 'rank-list-stretch' faz crescer em desktop -->
                        <ul id="risco-alunos-list" class="rank-list-stretch rank-list-mobile-constrain text-sm"></ul>
                    </div>
                    
                    <!-- DESISTENTES (91+ dias) - TEXTO ALTERADO AQUI -->
                     <div class="bg-slate-700/50 p-2 rounded-md">
                        <h4 class="font-bold text-slate-400 flex-shrink-0">Desistentes (91+ dias)</h4>
                        <!-- 'rank-list-stretch' faz crescer em desktop -->
                        <ul id="desistentes-alunos-list" class="rank-list-stretch rank-list-mobile-constrain text-sm"></ul>
                    </div>
                </div>
                
                <!-- Importar / Exportar (flex-shrink-0 para não encolher) -->
                <div class="mt-auto pt-4 border-t border-slate-700 space-y-2 flex-shrink-0">
                    <h4 class="text-sm font-semibold text-slate-300">Gestão de Dados (JSON)</h4>
                    <button onclick="exportData()" class="w-full py-2 px-4 rounded-md bg-green-600 hover:bg-green-500 text-white text-sm flex items-center justify-center custom-button">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i> Exportar
                    </button>
                    <button onclick="document.getElementById('fileInput').click()" class="w-full py-2 px-4 rounded-md bg-blue-600 hover:bg-blue-500 text-white text-sm flex items-center justify-center custom-button">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Importar
                    </button>
                    <input type="file" id="fileInput" accept="application/json" onchange="importData(event)" style="display: none;">
                </div>
            </section>
        </div>

        <!-- 2. STUDENT PROFILE VIEW (Escondido por padrão) -->
        <div id="profile-view" class="hidden">
            <!-- A estrutura de blocos A, B, C, D, E do aluno aparecerá aqui -->
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                <button onclick="voltarParaDashboard()" class="py-2 px-4 rounded-md bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium flex items-center custom-button">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Voltar para o Dashboard
                </button>
                <h2 id="profile-name-header" class="text-2xl font-bold text-indigo-400">Detalhes do Aluno</h2>
            </div>

            <div id="profile-content" class="panel p-6 space-y-6">
                <!-- Blocos A, B, C, D, E serão injetados aqui -->
            </div>
            
            <div id="profile-actions" class="mt-6 flex flex-wrap gap-4">
                <button onclick="registrarNovaAulaFromProfile()" class="py-3 px-6 rounded-md bg-green-600 hover:bg-green-500 text-white font-medium flex items-center custom-button">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Registrar Mais Uma Aula
                </button>
                <button onclick="editarAlunoProfile()" class="py-3 px-6 rounded-md bg-yellow-600 hover:bg-yellow-500 text-white font-medium flex items-center custom-button">
                    <i data-lucide="edit-3" class="w-5 h-5 mr-2"></i> Editar Perfil
                </button>
                <button onclick="confirmarExclusao()" class="py-3 px-6 rounded-md bg-red-600 hover:bg-red-500 text-white font-medium flex items-center custom-button">
                    <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i> Excluir
                </button>
            </div>
        </div>
    </main>

    <!-- 3. MODAL CUSTOMIZADO DE CONFIRMAÇÃO -->
    <div id="custom-modal" class="fixed inset-0 hidden items-center justify-center">
        <div class="modal-content p-6 rounded-xl w-11/12 max-w-sm">
            <h3 class="text-xl font-bold text-red-500 mb-4 flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i> Confirmação Necessária
            </h3>
            <p id="modal-message" class="text-slate-300 mb-6">Tem certeza que deseja excluir [Nome do Aluno]? Esta ação é irreversível.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="py-2 px-4 rounded-md bg-slate-600 hover:bg-slate-500 text-white font-medium custom-button">Cancelar</button>
                <button onclick="executeModalAction()" class="py-2 px-4 rounded-md bg-red-600 hover:bg-red-500 text-white font-medium custom-button">Excluir Permanentemente</button>
            </div>
        </div>
    </div>


    <!-- D. FUNCIONALIDADE JAVASCRIPT -->
    <script>
        // =================================================================
        // 1. MODELO DE DADOS E ESTADO DA APLICAÇÃO
        // =================================================================
        // Dados de Exemplo Ajustados para testar os novos limites de 31-90 e 91+
        let alunosData = [
            { id: 101, nome: "Ana Silva", pais: "Brasil", aulasTotal: 25, nivelCEFR: "C2", descNivel: "(Proficiência)", ultimaAulaDias: 5, rankPontos: 950, status: "Ativo" },
            { id: 102, nome: "João Melo", pais: "EUA", aulasTotal: 22, nivelCEFR: "B2", descNivel: "(Interm. Superior)", ultimaAulaDias: 10, rankPontos: 880, status: "Ativo" },
            { id: 103, nome: "Juliana Santos", pais: "Canadá", aulasTotal: 18, nivelCEFR: "C1", descNivel: "(Avançado)", ultimaAulaDias: 15, rankPontos: 820, status: "Ativo" },
            { id: 104, nome: "Joyce Souza", pais: "Japão", aulasTotal: 15, nivelCEFR: "A2", descNivel: "(Básico)", ultimaAulaDias: 20, rankPontos: 750, status: "Ausente" }, // 20 dias (Ausente: 1-30)
            { id: 105, nome: "Júnior Pereira", pais: "Brasil", aulasTotal: 14, nivelCEFR: "B1", descNivel: "(Intermediário)", ultimaAulaDias: 25, rankPontos: 680, status: "Ausente" }, // 25 dias (Ausente: 1-30)
            { id: 106, nome: "Jamile Costa", pais: "Portugal", aulasTotal: 12, nivelCEFR: "B2", descNivel: "(Interm. Superior)", ultimaAulaDias: 30, rankPontos: 610, status: "Ausente" }, // 30 dias (Ausente: 1-30)
            
            // Novos limites de Risco Crítico (31-90 dias)
            { id: 107, nome: "Ricardo L.", pais: "Espanha", aulasTotal: 10, nivelCEFR: "C1", descNivel: "(Avançado)", ultimaAulaDias: 35, rankPontos: 480, status: "Critico" }, // 35 dias (Critico: 31-90)
            { id: 108, nome: "Beatriz M.", pais: "Itália", aulasTotal: 9, nivelCEFR: "A2", descNivel: "(Básico)", ultimaAulaDias: 40, rankPontos: 450, status: "Critico" }, // 40 dias (Critico: 31-90)
            { id: 109, nome: "Cássio N.", pais: "Alemanha", aulasTotal: 8, nivelCEFR: "B1", descNivel: "(Intermediário)", ultimaAulaDias: 50, rankPontos: 400, status: "Critico" }, // 50 dias (Critico: 31-90)
            { id: 110, nome: "Thiago A.", pais: "Chile", aulasTotal: 7, nivelCEFR: "A2", descNivel: "(Básico)", ultimaAulaDias: 70, rankPontos: 350, status: "Critico" }, // 70 dias (Critico: 31-90)
            { id: 124, nome: "Úrsula A.", pais: "Costa Rica", aulasTotal: 12, nivelCEFR: "C1", descNivel: "(Avançado)", ultimaAulaDias: 90, rankPontos: 550, status: "Critico" }, // 90 dias (Critico: 31-90)
            
            // Novos limites de Desistente (91+ dias)
            { id: 125, nome: "Vinicius B.", pais: "Honduras", aulasTotal: 10, nivelCEFR: "A2", descNivel: "(Básico)", ultimaAulaDias: 95, rankPontos: 250, status: "Desistente" }, // 95 dias (Desistente: 91+)
            { id: 126, nome: "Wallace C.", pais: "Nicarágua", aulasTotal: 8, nivelCEFR: "B1", descNivel: "(Intermediário)", ultimaAulaDias: 100, rankPontos: 180, status: "Desistente" }, // 100 dias (Desistente: 91+)
            
            // Outros alunos ativos/ausentes para preencher as listas
            { id: 111, nome: "Felipe Gama", pais: "México", aulasTotal: 3, nivelCEFR: "A1", descNivel: "(Iniciante)", ultimaAulaDias: 10, rankPontos: 150, status: "Ativo" },
            { id: 112, nome: "Gustavo O.", pais: "Itália", aulasTotal: 1, nivelCEFR: "A1", descNivel: "(Iniciante)", ultimaAulaDias: 5, rankPontos: 100, status: "Ativo" },
            { id: 113, nome: "Helena P.", pais: "Alemanha", aulasTotal: 30, nivelCEFR: "B2", descNivel: "(Interm. Superior)", ultimaAulaDias: 12, rankPontos: 990, status: "Ativo" },
            { id: 114, nome: "Igor Q.", pais: "França", aulasTotal: 17, nivelCEFR: "C1", descNivel: "(Avançado)", ultimaAulaDias: 18, rankPontos: 800, status: "Ausente" }, // 18 dias
            { id: 115, nome: "Larissa R.", pais: "Argentina", aulasTotal: 13, nivelCEFR: "A2", descNivel: "(Básico)", ultimaAulaDias: 22, rankPontos: 700, status: "Ausente" }, // 22 dias
            { id: 116, nome: "Matheus S.", pais: "Colômbia", aulasTotal: 11, nivelCEFR: "B1", descNivel: "(Intermediário)", ultimaAulaDias: 27, rankPontos: 600, status: "Ausente" }, // 27 dias
        ];

        const RANKS = ["Challenger", "Grandmaster", "Master", "Diamond", "Emerald", "Platinum", "Gold", "Silver", "Bronze", "Iron"];
        const CEFR_DESCRIPTIONS = { "C2": "Proficiência", "C1": "Avançado", "B2": "Interm. Superior", "B1": "Intermediário", "A2": "Básico", "A1": "Iniciante" };
        
        let currentAlunoId = null; // Armazena o ID do aluno atualmente visualizado
        let currentFilterTerm = ''; // Armazena o termo de busca atual

        // =================================================================
        // 2. FUNÇÕES DE RENDERIZAÇÃO E CLASSIFICAÇÃO
        // =================================================================

        function getRankClass(index) {
             const rankName = RANKS[index];
             if (!rankName) return 'rank-iron';
             return `rank-${rankName.toLowerCase()}`;
        }
        
        function createStudentListItemHTML(aluno, index, isRanked = false) {
            const rankName = isRanked ? RANKS[index] : '';
            const rankClass = isRanked ? `rank-badge ${getRankClass(index)}` : 'hidden';
            
            // Ícone e cor de status na lista geral
            let statusIconHTML = '';
            let statusColor = 'text-white';
            let subtitle = `${aluno.aulasTotal} Aulas | ${aluno.pais}`;

            if (aluno.status === 'Ausente') {
                // Ausentes (1-30 dias) - AMARAELO
                statusIconHTML = '<i data-lucide="mail-plus" class="w-4 h-4 ml-2 text-yellow-400"></i>';
                statusColor = 'text-yellow-400';
                subtitle += ` | Ausente há ${aluno.ultimaAulaDias} dias`;
            } else if (aluno.status === 'Critico') {
                // Risco Crítico (31-90 dias) - VERMELHO
                statusIconHTML = '<i data-lucide="alert-octagon" class="w-4 h-4 ml-2 text-red-500"></i>';
                statusColor = 'text-red-500';
                subtitle += ` | Risco Crítico (${aluno.ultimaAulaDias} dias)`;
            } else if (aluno.status === 'Desistente') {
                 // Desistentes (91+ dias) - CINZA
                 statusIconHTML = '<i data-lucide="archive" class="w-4 h-4 ml-2 text-slate-400"></i>';
                 statusColor = 'text-slate-400';
                 subtitle += ` | Desistente (${aluno.ultimaAulaDias} dias)`;
            }

            return `
                <a href="#" onclick="openStudentProfile(${aluno.id}); return false;" class="p-2 flex justify-between items-center bg-slate-700/50 hover:bg-slate-700 rounded-md transition duration-150">
                    <div class="flex flex-col leading-snug">
                        <span class="truncate font-semibold ${statusColor} flex items-center">
                            ${isRanked ? `${index + 1}. ` : ''}${aluno.nome} 
                            ${statusIconHTML}
                        </span>
                        <span class="text-xs text-slate-400">${subtitle}</span>
                    </div>
                    <span class="text-xs font-bold text-indigo-300">Nível ${aluno.nivelCEFR}</span>
                </a>
            `;
        }


        /**
         * FUNÇÃO PRINCIPAL: RECARREGA TODO O DASHBOARD
         */
        function carregarDashboard() {
            // Recálculo de Status e Ranks
            const dadosClassificados = classificarAlunos();
            
            // Renderização de Colunas
            renderizarColunaEsquerda(alunosData); // Renderiza a lista completa, que será filtrada
            renderizarColunaCentral(alunosData, dadosClassificados.top10.length);
            renderizarColunaDireita(dadosClassificados);
            
            lucide.createIcons();
            console.log("-> Dashboard Recarregado e Classificado.");
        }


        /**
         * Renderiza a Coluna Esquerda (Lista Geral e Busca)
         */
        function renderizarColunaEsquerda(dataToRender) {
             const listContainer = document.getElementById('lista-alunos-geral');
             const totalMetrics = document.getElementById('total-alunos-aulas');

             const totalAlunos = alunosData.length;
             const totalAulas = alunosData.reduce((sum, aluno) => sum + aluno.aulasTotal, 0);
             
             // 1. Métrica Total de Alunos e Aulas
             totalMetrics.innerHTML = `
                 <span class="text-indigo-300 flex items-center">
                     <i data-lucide="users" class="w-4 h-4 mr-1"></i> ${totalAlunos} Alunos
                 </span>
                 <span class="text-yellow-300 flex items-center">
                     <i data-lucide="award" class="w-4 h-4 mr-1"></i> ${totalAulas} Aulas
                 </span>
             `;

             // 2. Renderiza a Lista (Filtrada ou Completa)
             listContainer.innerHTML = '';
             if (dataToRender.length === 0) {
                 listContainer.innerHTML = `<p class="placeholder-text">Nenhum aluno encontrado com o termo: "${currentFilterTerm}"</p>`;
                 return;
             }

             dataToRender.forEach(aluno => {
                 listContainer.innerHTML += createStudentListItemHTML(aluno);
             });
             lucide.createIcons();
        }

        /**
         * Renderiza a Coluna Central (Gráficos e Últimas Aulas)
         */
        function renderizarColunaCentral(alunos, totalTop10) {
            // Placeholder para Gráficos
            document.getElementById('metricas-e-graficos').querySelector('.placeholder-text').innerText = 
                `Gráficos Donut (Engajamento e Nível). Top 10 Alunos: ${totalTop10}.`;

            // Últimas Aulas Registradas
            // Filtra por alunos ativos ou ausentes (para não mostrar desistentes nesta lista)
            const ultimasAulas = alunos
                .filter(a => a.ultimaAulaDias <= 30)
                .sort((a, b) => b.ultimaAulaDias - a.ultimaAulaDias)
                .slice(0, 5);
            
            const ultimasAulasList = document.getElementById('ultimas-aulas-list');
            ultimasAulasList.innerHTML = '';

            if (ultimasAulas.length === 0) {
                 ultimasAulasList.innerHTML = '<li class="text-slate-400">Nenhuma aula recente nos últimos 30 dias.</li>';
            } else {
                ultimasAulas.forEach(aluno => {
                    ultimasAulasList.innerHTML += `
                        <li class="flex justify-between items-center p-1 rounded-sm bg-slate-700/30">
                            <span class="font-medium text-slate-200">${aluno.nome}</span>
                            <span class="text-xs text-green-400">Inativo há ${aluno.ultimaAulaDias} dias</span>
                        </li>
                    `;
                });
            }
        }
        
        /**
         * Renderiza a Coluna Direita (Rankings) - Aplicando Limites de 6 Alunos
         */
        function renderizarColunaDireita(dadosClassificados) {
            // TOP 10 (Limite de 10)
            const top10List = document.getElementById('top-10-alunos-list');
            top10List.innerHTML = '';
            dadosClassificados.top10.forEach((aluno, index) => {
                top10List.innerHTML += createStudentListItemHTML(aluno, index, true);
            });
            
            // AUSENTES (Limite de 6)
            const ausentesList = document.getElementById('ausentes-alunos-list');
            ausentesList.innerHTML = dadosClassificados.ausentes.slice(0, 6).map(a => createStudentListItemHTML(a)).join('');

            // RISCO CRÍTICO (Limite de 6)
            const riscoList = document.getElementById('risco-alunos-list');
            riscoList.innerHTML = dadosClassificados.riscoCritico.slice(0, 6).map(a => createStudentListItemHTML(a)).join('');
            
            // DESISTENTES (Limite de 6)
            const desistentesList = document.getElementById('desistentes-alunos-list');
            desistentesList.innerHTML = dadosClassificados.desistentes.slice(0, 6).map(a => createStudentListItemHTML(a)).join('');

             lucide.createIcons();
        }

        /**
         * Lógica de Classificação (Calcula Risco e Rank) - AJUSTADA CONFORME NOVO REQUISITO
         */
        function classificarAlunos() {
            alunosData.forEach(aluno => {
                // Alunos que abandonaram (desistentes) são 91+ dias
                if (aluno.ultimaAulaDias >= 91) {
                    aluno.status = 'Desistente';
                } 
                // Alunos em risco crítico são 31 a 90 dias
                else if (aluno.ultimaAulaDias >= 31 && aluno.ultimaAulaDias <= 90) {
                    aluno.status = 'Critico';
                } 
                // Alunos ausentes são 1 a 30 dias
                else if (aluno.ultimaAulaDias >= 1 && aluno.ultimaAulaDias <= 30) { 
                     aluno.status = 'Ausente';
                } else {
                    aluno.status = 'Ativo';
                }
            });
            
            // Classifica Top 10 (excluindo Desistentes)
            const top10 = alunosData
                .filter(a => a.status !== 'Desistente') 
                .sort((a, b) => b.rankPontos - a.rankPontos)
                .slice(0, 10); // Mantém o limite de 10

            // Classifica os grupos de Risco/Ausência
            const ausentes = alunosData.filter(a => a.status === 'Ausente');
            const riscoCritico = alunosData.filter(a => a.status === 'Critico');
            const desistentes = alunosData.filter(a => a.status === 'Desistente');

            // Importante: A limitação de .slice(0, 6) é feita na função renderizarColunaDireita()
            // para que a classificação completa permaneça aqui para fins de referência.
            
            return { top10, ausentes, riscoCritico, desistentes };
        }


        // =================================================================
        // 3. FUNÇÕES DE FLUXO E PERFIL (ABRIR/FECHAR)
        // =================================================================

        /**
         * Abre a tela de perfil do aluno (Substitui a Dashboard)
         * @param {number} id - ID do aluno clicado
         */
        function openStudentProfile(id) {
            const aluno = alunosData.find(a => a.id === id);
            if (!aluno) return;

            currentAlunoId = id;

            // Esconde Dashboard, Mostra Perfil
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');

            // Preenche o Perfil
            document.getElementById('profile-name-header').innerText = `Perfil de ${aluno.nome}`;
            
            // Simulação da estrutura de blocos A, B, C, D, E
            document.getElementById('profile-content').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Bloco A: Informações Principais -->
                    <div class="panel bg-slate-700 p-4">
                        <h4 class="text-lg font-semibold text-indigo-300 border-b border-indigo-600 mb-2">Bloco A: Básico</h4>
                        <p><strong>ID:</strong> ${aluno.id}</p>
                        <p><strong>Nome:</strong> ${aluno.nome}</p>
                        <p><strong>País:</strong> ${aluno.pais}</p>
                        <p><strong>Status Atual:</strong> <span class="font-bold text-green-400">${aluno.status}</span></p>
                    </div>
                    <!-- Bloco B: Performance e Rank -->
                    <div class="panel bg-slate-700 p-4">
                        <h4 class="text-lg font-semibold text-yellow-300 border-b border-yellow-600 mb-2">Bloco B: Performance</h4>
                        <p><strong>Aulas Concluídas:</strong> ${aluno.aulasTotal}</p>
                        <p><strong>Pontuação Rank:</strong> ${aluno.rankPontos}</p>
                        <p><strong>Última Aula:</strong> ${aluno.ultimaAulaDias} dias atrás</p>
                    </div>
                </div>
                <!-- Blocos C, D, E... (Placeholder) -->
                <div class="panel bg-slate-700 p-4">
                    <h4 class="text-lg font-semibold text-slate-300 border-b border-slate-600 mb-2">Blocos C, D, E: Detalhes do Questionário</h4>
                    <p class="text-sm">Aqui seriam exibidos os dados detalhados de nível, objetivo, histórico e filhos (vindos do questionário.html).</p>
                    <p class="text-sm mt-2 text-indigo-400">Nível CEFR: ${aluno.nivelCEFR} (${aluno.descNivel})</p>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Volta para a tela principal (Dashboard)
         */
        function voltarParaDashboard() {
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            currentAlunoId = null;
            carregarDashboard(); // Recarrega para garantir que os dados estejam atualizados
        }
        
        // =================================================================
        // 4. FUNÇÕES DE AÇÃO (Botões do Perfil)
        // =================================================================

        /**
         * Registra uma nova aula a partir da tela de Perfil.
         */
        function registrarNovaAulaFromProfile() {
            if (!currentAlunoId) return;

            const aluno = alunosData.find(a => a.id === currentAlunoId);
            if (aluno) {
                aluno.aulasTotal += 1;
                aluno.rankPontos += 100; // Pontuação maior para aula
                aluno.ultimaAulaDias = 0;

                // Não usamos alert(), mas simulamos uma notificação
                const notificationMessage = `Aula registrada com sucesso para ${aluno.nome}! Pontos atualizados.`;
                console.log(notificationMessage);
                
                // Recarrega o perfil para refletir a mudança
                openStudentProfile(currentAlunoId); 
                carregarDashboard();
            }
        }
        
        /**
         * Simulação da função Editar (Placeholder)
         */
        function editarAlunoProfile() {
            console.log("Funcionalidade de Edição ativada. Você poderia abrir um formulário pré-preenchido aqui.");
        }


        /**
         * Abre o modal customizado para confirmar exclusão.
         */
        function confirmarExclusao() {
            const aluno = alunosData.find(a => a.id === currentAlunoId);
            if (!aluno) return;
            
            document.getElementById('modal-message').innerHTML = `Tem certeza que deseja excluir o aluno <span class="font-bold text-red-400">${aluno.nome}</span>? Esta ação é irreversível e o rank será recalculado.`;
            document.getElementById('custom-modal').classList.add('flex');
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        /**
         * Executa a ação de exclusão (chamada pelo botão do modal)
         */
        function executeModalAction() {
            closeModal();
            excluirAluno(currentAlunoId);
            voltarParaDashboard();
        }

        /**
         * Fecha o modal customizado.
         */
        function closeModal() {
            document.getElementById('custom-modal').classList.remove('flex');
            document.getElementById('custom-modal').classList.add('hidden');
        }

        /**
         * Remove o aluno do array (Lógica principal de exclusão).
         * @param {number} alunoId - ID do aluno a ser removido.
         */
        function excluirAluno(alunoId) {
            const alunoIndex = alunosData.findIndex(a => a.id === alunoId);
            if (alunoIndex !== -1) {
                const alunoExcluido = alunosData[alunoIndex].nome;
                alunosData.splice(alunoIndex, 1);
                console.log(`-> FUNCIONALIDADE: Aluno ${alunoExcluido} EXCLUÍDO. Recalculando Rank...`);
                // O carregarDashboard() é chamado ao voltar, garantindo o recálculo
                return true;
            }
            return false;
        }

        /**
         * Filtra a lista de alunos (Busca Inteligente).
         */
        function filtrarAlunos(termo) {
            currentFilterTerm = termo.trim();
            const lowerCaseTermo = currentFilterTerm.toLowerCase();
            
            const filteredData = alunosData.filter(aluno => 
                aluno.nome.toLowerCase().includes(lowerCaseTermo)
            );
            
            // Se o usuário apagar tudo, a lista volta a ser completa
            if (currentFilterTerm === '') {
                 renderizarColunaEsquerda(alunosData);
            } else {
                 renderizarColunaEsquerda(filteredData);
            }
        }
        
        // =================================================================
        // 5. FUNÇÕES DE IMPORTAÇÃO/EXPORTAÇÃO (JSON)
        // =================================================================

        /**
         * Exporta os dados atuais para um arquivo JSON.
         */
        function exportData() {
            const dataStr = JSON.stringify(alunosData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'alunos_dashboard.json';

            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            console.log("Dados exportados com sucesso para 'alunos_dashboard.json'!");
        }

        /**
         * Importa dados de um arquivo JSON.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        alunosData = importedData;
                        console.log(`Sucesso! ${importedData.length} alunos importados.`);
                        carregarDashboard();
                    } else {
                        console.error("Erro: O arquivo JSON não contém uma lista válida de alunos.");
                    }
                } catch (error) {
                    console.error("Erro ao ler o arquivo JSON: " + error.message);
                }
            };
            reader.readAsText(file);
        }

        // =================================================================
        // INICIALIZAÇÃO
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Garante que os ícones e a lógica inicial sejam carregados
            lucide.createIcons();
            carregarDashboard();
            
            console.log("---------------------------------------");
            console.log("LOG: Lógica de Risco Atualizada:");
            console.log("  - Ausente: 1 a 30 dias (Amarelo)");
            console.log("  - Risco Crítico: 31 a 90 dias (Vermelho)");
            console.log("  - Desistente: 91+ dias (Cinza)");
            console.log("---------------------------------------");
        });
    </script>
</body>
</html>