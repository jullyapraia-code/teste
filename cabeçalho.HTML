<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plataforma Tutor - Cotação do Dólar em Tempo Real</title>

  <!-- Tailwind e Lucide para ícones -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { background-color: #0F172A; }
    .metric-value { font-size: 1.1rem; font-weight: bold; }
    .header-container { max-width: 100%; }
    .spinning { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>

<body class="p-0">
  <header class="header-container flex justify-center w-full">
    <div class="max-w-7xl w-full flex flex-col md:flex-row justify-between items-center text-white p-3 sm:p-4 bg-slate-900 border-b border-slate-700 shadow-lg">
      <div class="flex items-center mb-3 md:mb-0">
        <i data-lucide="graduation-cap" class="w-8 h-8 mr-3 text-indigo-400"></i>
        <div class="flex flex-col items-start">
          <span class="text-xl font-bold text-white leading-tight">Plataforma Tutor</span>
          <span class="text-sm text-slate-300 font-medium mt-0.5 flex items-center">
            <i data-lucide="mail" class="w-4 h-4 mr-1 text-slate-400"></i>
            usuario.logado@gmail.com
          </span>
        </div>
      </div>

      <div class="flex flex-wrap items-center justify-center gap-3 text-sm font-medium">
        <div class="bg-green-900/40 p-2 rounded-lg border border-green-600 flex items-center min-w-[100px] justify-between">
          <div class="flex flex-col">
            <span class="text-slate-400 text-xs">Dólar Atual</span>
            <span class="metric-value text-green-300" id="cotacao-dolar">R$ 5,00</span>
          </div>
          <button id="btn-refresh" class="text-green-400 hover:text-green-300 ml-2 transition duration-150 p-1 rounded-full" title="Atualizar cotação agora">
            <i id="icon-refresh" data-lucide="rotate-cw" class="w-4 h-4"></i>
          </button>
        </div>

        <div class="bg-red-900/40 p-2 rounded-lg border border-red-600 min-w-[120px]">
          <span class="text-slate-400 text-xs block">Taxa (1,5%)</span>
          <span class="metric-value text-red-300" id="desconto-usd">US$ 0,15</span>
        </div>

        <div class="bg-indigo-900/40 p-2 rounded-lg border border-indigo-600 min-w-[120px]">
          <span class="text-slate-400 text-xs block">Valor Líquido (USD)</span>
          <span class="metric-value text-indigo-300" id="total-bruto-usd">US$ 9,85</span>
        </div>

        <div class="bg-yellow-900/40 p-2 rounded-lg border border-yellow-600 min-w-[120px]">
          <span class="text-slate-400 text-xs block">Total em Reais</span>
          <span class="metric-value text-yellow-300" id="total-liquido-brl">R$ 49,25</span>
        </div>

        <button class="p-2 sm:p-3 rounded-full bg-slate-700 hover:bg-slate-600 transition duration-150 ml-2">
          <i data-lucide="menu" class="w-6 h-6 text-white"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- SCRIPT -->
  <script>
    const DEFAULT_DOLLAR_RATE = 5.00;
    const PLATFORM_FEE_RATE = 0.015;
    const AUTO_UPDATE_MS = 30 * 60 * 1000;
    const API_PRIMARY = 'https://api.exchangerate.host/latest?base=USD&symbols=BRL';
    const API_FALLBACK = 'https://api.frankfurter.app/latest?from=USD&to=BRL';

    let currentDollarRate = DEFAULT_DOLLAR_RATE;
    const cotacaoElement = document.getElementById('cotacao-dolar');
    const descontoUsdEl = document.getElementById('desconto-usd');
    const brutoUsdEl = document.getElementById('total-bruto-usd');
    const liquidoBrlEl = document.getElementById('total-liquido-brl');
    const btnRefresh = document.getElementById('btn-refresh');
    const iconRefresh = document.getElementById('icon-refresh');

    function formatBRL(value) {
      return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function formatUSD(value) {
      return value.toFixed(2).replace('.', ',');
    }

    function calculateMetrics(totalBrutoAntesTaxa = 10.00) {
      const descontoUSD = totalBrutoAntesTaxa * PLATFORM_FEE_RATE;
      const totalLiquidoUSD = totalBrutoAntesTaxa - descontoUSD;
      const totalLiquidoBRL = totalLiquidoUSD * currentDollarRate;

      descontoUsdEl.textContent = `US$ ${formatUSD(descontoUSD)}`;
      brutoUsdEl.textContent = `US$ ${formatUSD(totalLiquidoUSD)}`;
      liquidoBrlEl.textContent = `R$ ${formatBRL(totalLiquidoBRL)}`;
    }

    async function fetchJson(url) {
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error('Erro HTTP: ' + resp.status);
      return resp.json();
    }

    async function getDollarRate() {
      try {
        const data = await fetchJson(API_PRIMARY);
        if (data?.rates?.BRL) return data.rates.BRL;
        throw new Error('Formato inesperado (primária)');
      } catch {
        const data2 = await fetchJson(API_FALLBACK);
        if (data2?.rates?.BRL) return data2.rates.BRL;
        throw new Error('Formato inesperado (fallback)');
      }
    }

    async function updateDollarRate(showSpinner = false) {
      if (showSpinner) iconRefresh.classList.add('spinning');
      try {
        const rate = await getDollarRate();
        currentDollarRate = Math.round(rate * 100) / 100;
        cotacaoElement.textContent = `R$ ${formatBRL(currentDollarRate)}`;
        cotacaoElement.classList.remove('text-red-400', 'text-yellow-400');
        cotacaoElement.classList.add('text-green-300');
        calculateMetrics();
      } catch (err) {
        console.error('Erro ao buscar cotação:', err);
        cotacaoElement.textContent = `R$ ${formatBRL(currentDollarRate)} (erro)`;
        cotacaoElement.classList.remove('text-green-300', 'text-yellow-400');
        cotacaoElement.classList.add('text-red-400');
      } finally {
        if (showSpinner) iconRefresh.classList.remove('spinning');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      calculateMetrics();
      updateDollarRate(false);
      setInterval(() => updateDollarRate(false), AUTO_UPDATE_MS);
      btnRefresh.addEventListener('click', () => updateDollarRate(true));
    });
  </script>
</body>
</html>
